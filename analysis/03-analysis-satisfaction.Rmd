```{r setup-analysis-environment}
rm(list=ls())
load('../data/dcassvy.Rdata')
texcmds[['Rversion']] <- paste(R.version$major, R.version$minor, sep='.')
source('broom_mi.R') ## Saves multiple imputation
                     ## objects for use with tidyverse
```

```{r descriptives}
desc <- function(x, d=descriptives) {
    vals <- MIcombine(with(dcassvy, svymean(as.formula(paste0('~',x)))))
    return(data.frame(mean=vals$coefficients, se=sqrt(diag(vals$variance))))
}

## Independent variable (race)
d <- desc('dem.race')
tbl.names <- c("\\emph{Race}&&\\\\White", "Asian", "Black", "Latinx")

## Demographic variables
d <- rbind(d, desc('age'))
d['age','mean'] <- d['age','mean'] + 50
d <- rbind(d, desc('forborn')[2,])
d <- rbind(d, desc('man')[2,])
d <- rbind(d, desc('kids')[2,])
d <- rbind(d, desc('married')[2,])

tbl.names <- c(tbl.names, 
               c('\\emph{Demographics}&&\\\\Age', 'Foreign Born', 'Man', 
                 'Children present', 'Married'))

## Foreign-born by race
forborn.race <- summary(MIcombine(
    with(dcassvy, svyby(~I(forborn*1), ~dem.race, svymean))))$results*100 
forborn.race <- round(forborn.race, 0)
names(forborn.race) <- levels(dcas$dem.race)

## SES variables
d <- rbind(d, desc('educ')[c(2,1,3:5),])
tbl.names <- c(tbl.names,
               c('\\emph{Education}&&\\\\Less than H.S.','H.S. or G.E.D.',
                 'Some college', 'Bachelor\'s degree', 'Professional degree'))

## Neighborhood experience variables
d <- rbind(d, desc('nhdyrs'))
d['nhdyrs','mean'] <- d['nhdyrs','mean'] + 10 
d <- rbind(d, desc('nhdsize'))

tbl.names <- c(tbl.names, 
               '\\emph{Neighborhood Experience}\\\\Years in Neighborhood', 
               '1-9 blocks', '10-50 blocks', '>50 blocks')

## Make table of descriptives
d <- round(d, 2)
continuous_vars <- grep('age|nhdyrs',rownames(d), perl=TRUE)
d[-continuous_vars,'se'] <- ''
d <- data.frame(tbl.names, d)
descriptive_tbl <- as.table(as.matrix(d))
colnames(descriptive_tbl) <- c('Variable', 'Mean', 'S.D.')
```

```{r descriptive-output, echo=TRUE, include=TRUE}
kable(xtable(descriptive_tbl), row.names=FALSE)

print.xtable(xtable(descriptive_tbl,
                    caption='Means and standard deviations of independent and control variables',
                    align=c('l','l','p{.5in}','p{.5in}'), label='tab:descriptives'),
             booktabs=TRUE,
             caption.placement='top',
             include.rownames=FALSE,
             file='tables/descriptives.tex',
             sanitize.text.function = identity,
             timestamp='')
```

```{r reporting-functions}
source('report_models.R')
source('make_predictions.R')
get_aic <- function(d, m=5){ ## Record mean and between-model variance of AIC
    aics <- sapply(d, function(x) x$aic)
    return(list(mean=mean(aics), var=var(aics)))
}

MIcombine_aic <- function(m) { ## Combines imputations, including AIC
    aic <- get_aic(m)
    mi <- MIcombine(m)
    mi$aic <- aic
    return(mi)
}

```

```{r define-models}
m1 <- 'dem.race + sample_tract '
m2 <- paste0(m1, '+ age + I(forborn*1) + I(man*1) + I(kids*1) + I(married*1) +
                 educ')
m3 <- paste0(m2, '+ nhdyrs + nhdsize')
m4 <- sub('dem\\.race \\+ ','',m3)
```

```{r tract-clustering}
## Describe clustering of respondents within tracts
tract_Ns <- sapply(unique(dcas$sample_tract), 
                   function(x){nrow(dcas[dcas$sample_tract==x,])})
num_quads <- length(tract_Ns)
texcmds[['oneresp']] <- sum(tract_Ns==1)
texcmds[['medNpertract']] <- median(tract_Ns[tract_Ns>1])
texcmds[['maxNpertract']] <- max(tract_Ns)
tract_Nfreq <- as.data.frame(table(tract_Ns))
tract_Ns_hist <- ggplot(tract_Nfreq, aes(x=Freq)) + 
    geom_histogram(binwidth=1) +
    scale_x_continuous(breaks=1:19, labels=1:19) +
    labs(title="Distribution of respondents per tract",
         subtitle="Respondents living in quadrivial tracts, 2016 DCAS")
ggsave('images/distribution-of-tract-sample-sizes.png',plot=tract_Ns_hist,
       height=3, width=4, units='in')
```

```{r satisfied-mean}
mean_satisfied <- MIcombine(with(dcassvy,svymean(~satisfied)))
texcmds[['meansatisfied']] <- round(coef(mean_satisfied),2)[[1]]*100
satisfied_byrace <- MIcombine(
    with(dcassvy,svyby(~satisfied, ~I(dem.race), svymean))) %>%
    coef() %>% round(2)*100
texcmds[['apisatisfied']] <- round(satisfied_byrace[['api']])
texcmds[['nhbsatisfied']] <- round(satisfied_byrace[['black']])
texcmds[['hspsatisfied']] <- round(satisfied_byrace[['latino']])
texcmds[['nhwsatisfied']] <- round(satisfied_byrace[['white']])
```


```{r satisfied-analysis, warning=FALSE, results='hide'}
m0_sat <- with(dcassvy,
               svyglm(satisfied ~ sample_tract), family=binomial)
m0_sat <- MIcombine_aic(m0_sat)

m1_sat <- with(dcassvy,
               svyglm(as.formula(paste('satisfied ~',m1)), family=binomial))
sat_pred_m1 <- MIpredict(m1_sat)
sat_pred_m1$race <- levels(dcas$dem.race)
sat_pred_m1$model <- 'Race only'
m1_sat <- MIcombine_aic(m1_sat)

m2_sat <- with(dcassvy, svyglm(as.formula(paste('satisfied ~', m2)),
                               family=binomial))
m2_sat <- MIcombine_aic(m2_sat)

m3_sat <- with(dcassvy, svyglm(as.formula(paste('satisfied ~', m3)), 
                               family=binomial))
m3_sat_racewald <- lapply(m3_sat, regTermTest, test.terms=~dem.race, df=NULL)
sat_wald_F <- summary(sapply(m3_sat_racewald, function(x) x$Ftest))
sat_wald_p <- summary(sapply(m3_sat_racewald, function(x) x$p))
texcmds[['satWaldF']] <- round(sat_wald_F['Mean'], 2)[[1]]
texcmds[['satWaldpMin']] <- round(sat_wald_p['Min.'], 2)[[1]]
texcmds[['satWaldpMax']] <- round(sat_wald_p['Max.'], 2)[[1]]
sat_pred_m3 <- MIpredict(m3_sat)
sat_pred_m3$race <- levels(dcas$dem.race)
sat_pred_m3$model <- 'Race + controls'
m3_sat <- MIcombine_aic(m3_sat)
texcmds[['satnhdsize']] <- round(exp(coef(m3_sat)['nhdsize10-50 blocks']),2)[[1]]

m4_sat <- with(dcassvy, svyglm(as.formula(paste('satisfied ~', m4)),
                               family=binomial))
m4_sat <- MIcombine_aic(m4_sat)
```

```{r report-satisfaction-results, echo=TRUE, include=TRUE}
regression_labels <- c('Asian','Black','Latinx',
                       'Age','Foreign Born','Male',
                       'Children Present', 'Married',
                       levels(dcas$dem.educ.attain)[c(1,3:5)],
                       # levels(dcas$dem.income.cat4)[c(1,3:4)],
                       'Years in neighborhood',
                       '10-50 blocks', '>50 blocks')
sat_tbl <- report_models(m1_sat, m3_sat, m4_sat, reglabels=regression_labels,
                         caption=paste0('Estimated coefficients predicting ',
                                        ' neighborhood satisfaction'),
                         label='tab:satisfaction')
sat_tbl
cat(to_latex(sat_tbl), file='tables/satisfaction.tex')
```

```{r plot-satisfaction}
sat_pred <- rbind(sat_pred_m1, sat_pred_m3)
sat_pred$model <- relevel(factor(sat_pred$model), ref='Race only')
sat_pred$x <- c(seq(2,4.25,.75), seq(7,9.25,.75))
sat_pred$x <- rep(1:4,2)
sat_plt <- ggplot(sat_pred, aes(x=x, y=P)) + 
    geom_point() +
    geom_errorbar(aes(ymin=lci, ymax=uci), width=0.25) +
    # annotate(geom='text', x=c(3.125,8.125), y=1.05, 
    #          label=c('Race only', 'Race + controls'), size=4) +
    facet_grid(.~model) +
    scale_x_continuous(breaks=sat_pred$x, label=sat_pred$race) +
    # scale_x_continuous(limits=c(.5,11), breaks=sat_pred$x, label=sat_pred$race,
    #                    minor_breaks = c()) +
    scale_y_continuous(limits=c(0,1), breaks=seq(0,1,.2)) +
    # theme_bw() +
    labs(y='Proportion satisfied in neighborhood', x='Race') +
    theme(panel.spacing.x = unit(2.5,'lines'))
sat_plt
ggsave('images/satisfied.png', plot=sat_plt, 
       height=3, width=4, units='in')
diff_m1 <- max(sat_pred_m1['P']) - min(sat_pred_m1['P'])
texcmds[['maxdiffone']] <- round(diff_m1,2)*100
diff_m3 <- max(sat_pred_m3['P']) - min(sat_pred_m3['P'])
texcmds[['maxdiffthree']] <- round(diff_m3,2)*100
```
