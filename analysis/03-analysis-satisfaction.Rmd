# Analysis
```{r setup-analysis-environment}
rm(list=ls())
load('../data/dcassvy.Rdata')
```

## Analytical Approach
For each analysis, ran three models. 

1. Race-only model
2. Race and demographic controls
3. Race, demographic, and neighborhood perception variables

* Can't "prove a null" in this case, so will examine how much overlap there is in the confidence intervals (I need to work on explaining this better; any suggestions would be most welcome) [Create subsection at end of **Analysis** to address "proving the null"?]

## Fixed Effects
```{r tract-clustering}
## Describe clustering of respondents within tracts
tract_Ns <- sapply(unique(dcas$sample_tract), 
                   function(x){nrow(dcas[dcas$sample_tract==x,])})
num_quads <- length(tract_Ns)
N_oneresp <- sum(tract_Ns==1)
tract_Ns_max <- max(tract_Ns)
tract_Nfreq <- as.data.frame(table(tract_Ns))
tract_Ns_hist <- ggplot(tract_Nfreq, aes(x=Freq)) + 
    geom_histogram(binwidth=1) +
    scale_x_continuous(breaks=1:19, labels=1:19) +
    labs(title="Distribution of respondents per tract",
         subtitle="Respondents living in quadrivial tracts, 2016 DCAS")
ggsave('images/distribution-of-tract-sample-sizes.png',plot=tract_Ns_hist,
       height=3, width=4, units='in')
```

The correct test of the hypotheses compares the responses of white residents to those of blacks, Latinos, and Asians, *living in the same neighborhood*. As a result, I include fixed effects for each census tract in which respondents resided. Only one respondent lived in `r N_oneresp` tracts, and were therefore dropped from the analysis. Without these tracts, the number of respondents per tract ranged from 2 to `r tract_Ns_max`.

```{r define-models}
m1 <- 'dem.race'
m2 <- paste0(m1, '+ age + forborn + man + kids + married + educ')
m3 <- paste0(m2, '+ nhdyrs + nhdsize')
source('report_models.R')
```

## Multiple Imputation & Survey Weights
Several variables have a substantial amount of missing data. I used the Amelia package (cite) to create five imputation datasets that will be combined for the final results. I then set up the survey dseign using the list of imputed datasets to account for the complex survey design.

```{r multiple-imputation-functions}
source('broom_mi.R') ## Saves multiple imputation
                     ## objects for use with tidyverse
```

## Descriptive Statistics of Independent & Control Variables
```{r descriptives}
desc <- function(x, d=descriptives) {
    vals <- MIcombine(with(dcassvy, svymean(as.formula(paste0('~',x)))))
    return(data.frame(mean=vals$coefficients, se=sqrt(diag(vals$variance))))
}

## Independent variable (race)
d <- desc('dem.race')
tbl.names <- c("\\emph{Race}&&\\\\White", "Asian", "Black", "Latinx")

## Demographic variables
d <- rbind(d, desc('age'))
d <- rbind(d, desc('forborn')[2,])
d <- rbind(d, desc('man')[2,])
d <- rbind(d, desc('kids')[2,])
d <- rbind(d, desc('married')[2,])

tbl.names <- c(tbl.names, 
               c('\\emph{Demographics}&&\\\\Age', 'Foreign Born', 'Man', 
                 'Children present', 'Married'))

## SES variables
d <- rbind(d, desc('educ'))
tbl.names <- c(tbl.names,
               c('\\emph{Education}&&\\\\Less than H.S.','H.S. or G.E.D.',
                 'Some college', 'Bachelor\'s degree', 'Professional degree'))

## Neighborhood experience variables
d <- rbind(d, desc('nhdyrs'))
d <- rbind(d, desc('nhdsize'))

tbl.names <- c(tbl.names, 
               '\\emph{Neighborhood Experience}\\\\Years in Neighborhood', 
               '1-9 blocks', '10-50 blocks', '>50 blocks')

## Make table of descriptives
d <- round(d, 2)
continuous_vars <- grep('age|nhdyrs',rownames(d), perl=TRUE)
d[-continuous_vars,'se'] <- ''
d <- data.frame(tbl.names, d)
descriptive_tbl <- as.table(as.matrix(d))
colnames(descriptive_tbl) <- c('Variable', 'Mean', 'S.D.')
```

```{r descriptive-output, echo=TRUE, include=TRUE}
kable(xtable(descriptive_tbl), row.names=FALSE)

print.xtable(xtable(descriptive_tbl,
                    caption='Un-weighted means and standard deviations of independent and control variables',
                    align=c('l','l','p{.5in}','p{.5in}'), label='tab:descriptives'),
             booktabs=TRUE,
             caption.placement='top',
             include.rownames=FALSE,
             file='tables/descriptives.tex',
             sanitize.text.function = identity,
             timestamp='')
```

# Results 

## Satisfaction in Multiethnic Neighborhoods

### Bivariate Analysis
Plot the mean value of satisfaction by each racial group using survey weights.

```{r dependent-descriptives}
mean_satisfied <- MIcombine(with(dcassvy,
                                 svymean(~satisfied)))
summary(mean_satisfied)
```
Overall, `r round(coef(mean_satisfied)[2], 2)*100` percent of residents in the sample were either very or extremely satisfied with their neighborhoods.

```{r satisfaction-bivariate}
satisfied_means <- MIcombine(with(dcassvy,
                                  svyby(~satisfied, ~dem.race, svymean)))
satisfied_ci <- 1.96*sqrt(diag(satisfied_means$variance))
satisfied_vals <- data.frame(dem.race=c('White','Asian','Black','Latinx'),
                             satisfied=coef(satisfied_means)[5:8],
                             ci=satisfied_ci[5:8])
satisfied_plt <- ggplot(satisfied_vals, aes(x=dem.race, y=satisfied)) +
    geom_errorbar(aes(ymin=satisfied-ci, ymax=satisfied+ci), width=0.1) +
    geom_point() +
    scale_y_continuous(limits=c(0,1), breaks=seq(0,1,.20)) +
    labs(y='Proportion', x='Race')
satisfied_plt
ggsave('images/satisfied_descriptive.png', plot=satisfied_plt,
       height=3, width=4, units='in')
```

```{r report-satisfied-bivariate-plot, echo=TRUE, include=TRUE}
satisfied_plt
```

(I plan to make this plot show the un-adjusted and adjusted results)

### Multivariate Analysis
**Satisfied.**

```{r satisfied-analysis, warning=FALSE, results='hide'}
m1_sat <- MIcombine(with(dcassvy,
                         svyglm(as.formula(paste('satisfied ~',m1)), 
                                family=quasibinomial)))
m2_sat <- MIcombine(with(dcassvy,
                         svyglm(as.formula(paste('satisfied ~', m2)),
                                family=quasibinomial)))
summary(m2_sat)
m3_sat <- MIcombine(with(dcassvy,
                         svyglm(as.formula(paste('satisfied ~', m3)), 
                                family=quasibinomial)))
summary(m3_sat)
```

```{r report-satisfaction-analysis, echo=TRUE, include=TRUE}
regression_labels <- c('Asian','Black','Latinx',
                       'Age','Foreign Born','Male',
                       'Children Present', 'Married',
                       levels(dcas$dem.educ.attain)[c(1:4)],
                       # levels(dcas$dem.income.cat4)[c(1,3:4)],
                       'Years in neighborhood',
                       '1-9 blocks', '10-50 blocks')
sat_tbl <- report_models(m1_sat, m2_sat, m3_sat, reglabels=regression_labels,
                         caption=paste0('Estimated coefficients predicting ',
                                        ' neighborhood satisfaction'),
                         label='tab:satisfaction')
sat_tbl
cat(to_latex(sat_tbl), file='tables/satisfaction.tex')
```

Those who perceived their neighborhoods to be 1-9 blocks were `r round(exp(coef(m3_sat)['nhdsize1c']),3)` as likely to find satisfaction in their neighborhood. Those who perceived their neighborhoods to be greater than 50 blocks were `r round(exp(coef(m3_sat)['nhdsize3c']),3)` as likely to find satisfaction, but the difference was not distinguishable from those who perceived their neighborhoods to be between 10 and 50 blocks.

**Extremely Satisfied.** Calculate the proportion of respondents who are *extremely* satisfied by each racial group. (I think that I should add these results to a "robustness checks" section)

```{r bivariate-extremely-satisfied}

extreme_means <- MIcombine(with(dcassvy,
                                svyby(~extremely_satisfied, ~dem.race, svymean)))
extreme_diffs <- MIcombine(with(dcassvy, 
                                svyglm(extremely_satisfied ~ dem.race,
                                       family=quasibinomial)))
extreme_prob_white <- exp(coef(extreme_diffs)[1])/(1+exp(coef(extreme_diffs)[1]))
extreme_odds <- exp(coef(extreme_diffs))
```

`r round(extreme_prob_white, 2)*100` percent of white residents reported being extremely satisfied with their neighborhoods. That value was
`r round(1/extreme_odds[['dem.raceapi']],2)` times higher than Asians,
`r round(1/extreme_odds[['dem.raceblack']],2)` times higher than blacks, and
`r round(1/extreme_odds[['dem.racelatino']],2)` times than Latinx residents.

```{r extremely-satisfied-analysis, results='hide'}
m1_esat <- MIcombine(with(dcassvy,
                          svyglm(as.formula(paste('extremely_satisfied ~', m1)),
                                 family=binomial)))
summary(m1_esat)
m2_esat <- MIcombine(with(dcassvy,
                          svyglm(as.formula(paste('extremely_satisfied ~', m2)),
                                 family=quasibinomial)))
summary(m2_esat)
m3_esat <- MIcombine(with(dcassvy,
                          svyglm(as.formula(paste('extremely_satisfied ~', m3)),
                                 family=quasibinomial)))
summary(m3_esat)
```

```{r report-extreme-satisfaction, echo=TRUE, include=TRUE}
esat_tbl <- report_models(m1_esat, m2_esat, m3_esat, 
                          reglabels=regression_labels, 
                          caption=paste0('Estimated coefficients predicting ',
                                         ' extreme neighborhood satisfaction'),
                          label='tab:satisfaction')
esat_tbl
cat(to_latex(esat_tbl), file='tables/extreme_satisfaction.tex')
```

