# Analysis
```{r setup-analysis-environment}
rm(list=ls())
load('../data/dcassvy.Rdata')
```
## Analytical Approach
For each analysis, ran three models. 

1. Race-only model
2. Race and demographic controls
3. Race, demographic, and neighborhood perception variables

* Can't "prove a null" in this case, so will examine how much overlap there is in the confidence intervals (I need to work on explaining this better; any suggestions would be most welcome) [Create subsection at end of **Analysis** to address "proving the null"?]

```{r reporting-functions}
source('report_models.R')
source('make_predictions.R')
get_aic <- function(d, m=5){ ## Record mean and between-model variance of AIC
    aics <- sapply(d, function(x) x$aic)
    return(list(mean=mean(aics), var=var(aics)))
}

MIcombine_aic <- function(m) { ## Combines imputations, including AIC
    aic <- get_aic(m)
    mi <- MIcombine(m)
    mi$aic <- aic
    return(mi)
}

```

## Fixed Effects
```{r tract-clustering}
## Describe clustering of respondents within tracts
tract_Ns <- sapply(unique(dcas$sample_tract), 
                   function(x){nrow(dcas[dcas$sample_tract==x,])})
num_quads <- length(tract_Ns)
N_oneresp <- sum(tract_Ns==1)
tract_Ns_max <- max(tract_Ns)
tract_Nfreq <- as.data.frame(table(tract_Ns))
tract_Ns_hist <- ggplot(tract_Nfreq, aes(x=Freq)) + 
    geom_histogram(binwidth=1) +
    scale_x_continuous(breaks=1:19, labels=1:19) +
    labs(title="Distribution of respondents per tract",
         subtitle="Respondents living in quadrivial tracts, 2016 DCAS")
ggsave('images/distribution-of-tract-sample-sizes.png',plot=tract_Ns_hist,
       height=3, width=4, units='in')
```

The correct test of the hypotheses compares the responses of white residents to those of blacks, Latinos, and Asians, *living in the same neighborhood*. As a result, I include fixed effects for each census tract in which respondents resided. Only one respondent lived in `r N_oneresp` tracts, and were therefore dropped from the analysis. Without these tracts, the number of respondents per tract ranged from 2 to `r tract_Ns_max`.

```{r define-models}
m1 <- 'dem.race + sample_tract '
m2 <- paste0(m1, '+ age + I(forborn*1) + I(man*1) + I(kids*1) + I(married*1) +
                 educ')
m3 <- paste0(m2, '+ nhdyrs + nhdsize')
m4 <- sub('dem\\.race \\+ ','',m3)
```

## Multiple Imputation & Survey Weights
Several variables have a substantial amount of missing data. I used the Amelia package (cite) to create five imputation datasets that will be combined for the final results. I then set up the survey dseign using the list of imputed datasets to account for the complex survey design.

```{r multiple-imputation-functions}
source('broom_mi.R') ## Saves multiple imputation
                     ## objects for use with tidyverse
```

## Descriptive Statistics of Independent & Control Variables
```{r descriptives}
desc <- function(x, d=descriptives) {
    vals <- MIcombine(with(dcassvy, svymean(as.formula(paste0('~',x)))))
    return(data.frame(mean=vals$coefficients, se=sqrt(diag(vals$variance))))
}

## Independent variable (race)
d <- desc('dem.race')
tbl.names <- c("\\emph{Race}&&\\\\White", "Asian", "Black", "Latinx")

## Demographic variables
d <- rbind(d, desc('age'))
d['age','mean'] <- d['age','mean'] + 50
d <- rbind(d, desc('forborn')[2,])
d <- rbind(d, desc('man')[2,])
d <- rbind(d, desc('kids')[2,])
d <- rbind(d, desc('married')[2,])

tbl.names <- c(tbl.names, 
               c('\\emph{Demographics}&&\\\\Age', 'Foreign Born', 'Man', 
                 'Children present', 'Married'))

## Foreign-born by race
forborn.race <- summary(MIcombine(
    with(dcassvy, svyby(~I(forborn*1), ~dem.race, svymean))))$results*100 
forborn.race <- round(forborn.race, 0)
names(forborn.race) <- levels(dcas$dem.race)

## SES variables
d <- rbind(d, desc('educ')[c(2,1,3:5),])
tbl.names <- c(tbl.names,
               c('\\emph{Education}&&\\\\Less than H.S.','H.S. or G.E.D.',
                 'Some college', 'Bachelor\'s degree', 'Professional degree'))

## Neighborhood experience variables
d <- rbind(d, desc('nhdyrs'))
d['nhdyrs','mean'] <- d['nhdyrs','mean'] + 10 
d <- rbind(d, desc('nhdsize'))

tbl.names <- c(tbl.names, 
               '\\emph{Neighborhood Experience}\\\\Years in Neighborhood', 
               '1-9 blocks', '10-50 blocks', '>50 blocks')

## Make table of descriptives
d <- round(d, 2)
continuous_vars <- grep('age|nhdyrs',rownames(d), perl=TRUE)
d[-continuous_vars,'se'] <- ''
d <- data.frame(tbl.names, d)
descriptive_tbl <- as.table(as.matrix(d))
colnames(descriptive_tbl) <- c('Variable', 'Mean', 'S.D.')
```

```{r descriptive-output, echo=TRUE, include=TRUE}
kable(xtable(descriptive_tbl), row.names=FALSE)

print.xtable(xtable(descriptive_tbl,
                    caption='Means and standard deviations of independent and control variables',
                    align=c('l','l','p{.5in}','p{.5in}'), label='tab:descriptives'),
             booktabs=TRUE,
             caption.placement='top',
             include.rownames=FALSE,
             file='tables/descriptives.tex',
             sanitize.text.function = identity,
             timestamp='')
```

Residents of multiethnic neighborhoods are:

* Racially diverse
* Likely to be foreign-born: `r d['forbornTRUE',2]*100`% of respondents are foreign born. This varied by racial group, however: `r forborn.race['api']`% of Asian residents were born abroad, `r forborn.race['latino']`% of Latinos, and even `r forborn.race['black']`% of blacks while an overwhelming majority of whites (`r 100-forborn.race['white']`%) were native-born. 
* Residents are highly educated as almost a third hold a bachelor's degree and another third hold an advanced degree
* Nearly two-thirds report being married

# Results 

## Satisfication Living in Multiethnic Neighborhoods
```{r satisfied-mean}
mean_satisfied <- MIcombine(with(dcassvy,svymean(~satisfied)))
satisfied_byrace <- MIcombine(
    with(dcassvy,svyby(~satisfied, ~I(dem.race), svymean))) %>%
    coef() %>% round(2)*100
```

Most residents of multiethnic neighborhoods, `r round(coef(mean_satisfied), 2)*100` percent, are satisfied living in their neighborhood. Satisfaction was equally high among all four racial groups: `r satisfied_byrace['api']` percent of Asians, `r satisfied_byrace['latino']` percent of Latinxs, `r satisfied_byrace['black']` percent of blacks, and `r satisfied_byrace['white']` percent of whites in the sample were either "extremely" or "very" satisfied living in their multiethnic neighborhoods.

The agreement across racial groups held when I statistically compared groups within the same neighborhoods by modeling satisfaction with neighborhood fixed effects. The first column of Table \@ref(tab:satisfaction) reports the results of a model including only respondent race and neighborhood fixed effects. The estimates for racial groups are small and not distinguishable from zero. 

[Table \@ref(tab:satisfaction) about here]

```{r satisfied-analysis, warning=FALSE, results='hide'}
m0_sat <- with(dcassvy,
               svyglm(satisfied ~ sample_tract), family=binomial)
m0_sat <- MIcombine_aic(m0_sat)

m1_sat <- with(dcassvy,
               svyglm(as.formula(paste('satisfied ~',m1)), family=binomial))
sat_pred_m1 <- MIpredict(m1_sat)
sat_pred_m1$race <- levels(dcas$dem.race)
sat_pred_m1$model <- 'Race only'
m1_sat <- MIcombine_aic(m1_sat)

m2_sat <- with(dcassvy, svyglm(as.formula(paste('satisfied ~', m2)),
                               family=binomial))
m2_sat <- MIcombine_aic(m2_sat)

m3_sat <- with(dcassvy, svyglm(as.formula(paste('satisfied ~', m3)), 
                               family=binomial))
m3_sat_racewald <- lapply(m3_sat, regTermTest, test.terms=~dem.race, df=NULL)
sat_wald_F <- summary(sapply(m3_sat_racewald, function(x) x$Ftest))
sat_wald_p <- summary(sapply(m3_sat_racewald, function(x) x$p))
sat_pred_m3 <- MIpredict(m3_sat)
sat_pred_m3$race <- levels(dcas$dem.race)
sat_pred_m3$model <- 'Race + controls'
m3_sat <- MIcombine_aic(m3_sat)

m4_sat <- with(dcassvy, svyglm(as.formula(paste('satisfied ~', m4)),
                               family=binomial))
m4_sat <- MIcombine_aic(m4_sat)
```

```{r report-satisfaction-results, echo=TRUE, include=TRUE}
regression_labels <- c('Asian','Black','Latinx',
                       'Age','Foreign Born','Male',
                       'Children Present', 'Married',
                       levels(dcas$dem.educ.attain)[c(1,3:5)],
                       # levels(dcas$dem.income.cat4)[c(1,3:4)],
                       'Years in neighborhood',
                       '10-50 blocks', '>50 blocks')
sat_tbl <- report_models(m1_sat, m3_sat, m4_sat, reglabels=regression_labels,
                         caption=paste0('Estimated coefficients predicting ',
                                        ' neighborhood satisfaction'),
                         label='tab:satisfaction')
sat_tbl
cat(to_latex(sat_tbl), file='tables/satisfaction.tex')
```

To further show the lack of difference between racial groups, I plotted the predicted probability from the model in the left panel of Figure \@ref(fig:satisfaction). The plotted figures represent the predicted probability in the neighborhood with median satisfaction in the data, and reflect the estimates predicted across the five imputed data sets combined using Rubin's rules **[need cite]**. **[Look into replacing this estimate with the AME]** Only `r round(max(sat_pred_m1['P']) - min(sat_pred_m1['P']),2)*100` percent separated the most satisfied group (Latinxs) from the least satisfied (Asians). 

[Figure \@ref(fig:satisfaction) about here]

The second column of Table \@ref(tab:satisfaction) further confirmed that satisfaction was an interracial sentiment among residents of multiethnic neighborhoods. The estimates were again small and could not be distinguished from a null effect. The right panel of Figure \@ref{fig:satisfaction} shows the predicted probabilities of satisfaction from the model with controls. I estimated the probabilities and standard errors at the reference level for all other variables in the model, meaning the figure represents the satisfaction of a 50-year-old, native-born, unmarried woman with a high school degree and no children who has lived in her neighborhood for 10 years. **[Look into replacing this estimate with the AME]** In the complete model, only `r round(max(sat_pred_m3[,'P']) - min(sat_pred_m3[,'P']), 2)*100` separated the least satisfied group (now whites) from the most satisfied (still Latinxs). 

Not only are individual coefficients not large or statistically singificant, but including race does not improve the explanatory power of the model. The final column of Table \@ref(tab:satisfaction) reports the results of model estimating satisfaction in which I did not include race. The bottom row of the table reports the Akaike information criterion (AIC), a measure that balances a model's parsimony with its goodness of fit to the data **[need cite]**. A lower AIC represents a better fit to the data, and we can observe from Table \@ref(tab:satisfaction) that the model without race fits the data better than the model that includes race. I further affirmed the lack of explanatory power attributable to race by conducting Wald's F-test between the models with and without race. The mean value of the test across the imputed data sets was `r round(sat_wald_F['Mean'], 2)`, and the p-values ranged from `r round(sat_wald_p['Min.'], 2)` to `r round(sat_wald_p['Max.'], 2)`.

These results establish that residents are satisfied living in multiethnic neighborhoods regardless of their own race. Two other factors, education and the perceived size of the neighborhood, are associated with neighborhood satisfaction rather than race. Education had a curvilinear relationship with satisfaction among multiethnic neighborhood residents. Residents of multiethnic neighborhoods with a high school degree were the most satisfied, while residents with less than a high school education and those with a postgraduate degree felt satisfaction the least often. The perceived size of the neighborhood also mattered, as those residents who thought their neighborhood comprised 10-50 blocks were `r round(exp(coef(m3_sat)['nhdsize10-50 blocks']),2)` times more likely to be satisfied than those who perceived their neighborhood to be only one to nine blocks. **[Connect back to idea that this is a sufficient size to avoid the worst of microsegregation, so people are actually satisfied with their neighborhood with multiracial composition.]**

<!-- Those who perceived their neighborhoods to be 1-9 blocks were `r round(exp(coef(m3_sat)['nhdsize1c']),3)` as likely to find satisfaction in their neighborhood. Those who perceived their neighborhoods to be greater than 50 blocks were `r round(exp(coef(m3_sat)['nhdsize3c']),3)` as likely to find satisfaction, but the difference was not distinguishable from those who perceived their neighborhoods to be between 10 and 50 blocks. -->

```{r plot-satisfaction}
sat_pred <- rbind(sat_pred_m1, sat_pred_m3)
sat_pred$model <- relevel(factor(sat_pred$model), ref='Race only')
sat_pred$x <- c(seq(2,4.25,.75), seq(7,9.25,.75))
sat_pred$x <- rep(1:4,2)
sat_plt <- ggplot(sat_pred, aes(x=x, y=P)) + 
    geom_point() +
    geom_errorbar(aes(ymin=lci, ymax=uci), width=0.25) +
    # annotate(geom='text', x=c(3.125,8.125), y=1.05, 
    #          label=c('Race only', 'Race + controls'), size=4) +
    facet_grid(.~model) +
    scale_x_continuous(breaks=sat_pred$x, label=sat_pred$race) +
    # scale_x_continuous(limits=c(.5,11), breaks=sat_pred$x, label=sat_pred$race,
    #                    minor_breaks = c()) +
    scale_y_continuous(limits=c(0,1), breaks=seq(0,1,.2)) +
    # theme_bw() +
    labs(y='Proportion satisfied in neighborhood', x='Race') +
    theme(panel.spacing.x = unit(2.5,'lines'))
sat_plt
ggsave('images/satisfied.png', plot=sat_plt, 
       height=3, width=4, units='in')
```
