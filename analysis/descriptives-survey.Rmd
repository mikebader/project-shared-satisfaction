# Sample Descriptive Statistics

Setup data & environment to analyze.[^stochastic] 

[^stochastic]: The data loaded here were created in the file `analysis/01-variable-data-construction.Rmd`. Due to the stochasticity of the multiple imputations, new data generated by sourcing that file will result in minor differences in the final output. 

```{r surveys-setup}
# rm(list=ls())
load('../data/dcassvy.Rdata')
texcmds[['Rversion']] <- paste(R.version$major, R.version$minor, sep='.')

## Helper functions for analyzing and reporting results
source('R/broom_mi.R')
source('R/report_descriptives.R')
source('R/report_models.R')
source('R/make_predictions.R')
source('R/marginal_effects.R')

```

Include only rows in which respondent is one of four mutually exclusive racial groups. 

```{r surveys-include-fourraces}
fourraces <- c('white', 'asian', 'black', 'latino')
dcas16svy <- subset(dcas16svy, anarace==TRUE) %>%
    update(raceeth = factor(raceeth, levels=fourraces))
dcas18svy <- subset(dcas18svy, anarace==TRUE) %>%
    update(raceeth = factor(raceeth, levels=fourraces))

```


Create tables with descriptive results of both DCAS samples, overall and by race. The tables are constructed using two helper functions saved in `report_descriptives.R`:

`desc`

: Returns the summary of the multiply-imputed survey mean 

`make.desc`

: Returns the table of descriptive statistics

Results are saved in `tables/descriptives_dcas16.tex` and `tables/descriptives_dcas18.tex`.

Make table of overall descriptive statistics and by race for DCAS 2016 and DCAS 2018. 

```{r surveys-descriptives-table, include=FALSE}
d16 <- make.desc(dcas16svy) %>%
    cbind(make.desc(subset(dcas16svy, raceeth=='asian'))) %>%
    cbind(make.desc(subset(dcas16svy, raceeth=='black'))) %>%
    cbind(make.desc(subset(dcas16svy, raceeth=='latino'))) %>%
    cbind(make.desc(subset(dcas16svy, raceeth=='white'))) %>%
    round(2)

d18 <- make.desc(dcas18svy) %>%
    cbind(make.desc(subset(dcas18svy, raceeth=='asian'))) %>%
    cbind(make.desc(subset(dcas18svy, raceeth=='black'))) %>%
    cbind(make.desc(subset(dcas18svy, raceeth=='latino'))) %>%
    cbind(make.desc(subset(dcas18svy, raceeth=='white'))) %>%
    round(2)

tbl.names <- c(
    'White', 'Asian', 'Black', 'Latinx',
    'Age', 'Foreign born', 'Man', 'Children present',
    'Married',
    'Less than H.S.','H.S. or G.E.D.','Some college',
    'Bachelor\'s degree', 'Professional degree',
    'Years in neighborhood',
    '1-9 blocks',  '10-50 blocks',
    '>50 blocks'
)

make_descriptive_table <- function(dtab) {

    ## Remove standard deviations from dichotomous & factor variables
    continuous_vars <- grep('age|nhdyrs',rownames(dtab), perl=TRUE)
    dtab[-continuous_vars,c(2,4,6,8,10)] <- ""
    
    ## Remove race descriptives for single-race subsets
    dtab[1:4, 3:10] <- ""

    ## Format table for export using xtable
    nms <- c(tbl.names, rownames(dtab)[nrow(dtab)])
    dtab <- data.frame(nms, dtab)
    descriptive_tbl <- as.table(as.matrix(dtab))
    colnames(descriptive_tbl) <- c('Variable', rep(c('Mean', 'S.D.'),5))
    rownames(descriptive_tbl) <- c(nms)
    return(descriptive_tbl)
}
descriptive_tbls <- lapply(list(d16, d18), make_descriptive_table)
names(descriptive_tbls) <- c("d16", "d18")

desc16 <- descriptive.table(
    table   = descriptive_tbls[["d16"]],
    fname   = 'tables/descriptives_dcas16.tex',
    caption = paste("Means and standard deviations of independent and",
                    "control variables, DCAS2016 multiracial",
                    "neighborhood sample"),
    lab     = "tab:descriptives16"
)
desc16

desc18 <- descriptive.table(
    table   = descriptive_tbls[["d18"]],
    fname   = 'tables/descriptives_dcas18.tex',
    caption = paste("Means and standard deviations of independent and",
                    "control variables, DCAS2018 sample  (N=",
                    nrow(dcas18svy$designs$imp1),")"),
    lab     = "tab:descriptives18"
)
desc18
```

Missingness of education and income in 2016 and 2018.

: 
    ```{r surveys-missing}
    mi16 <- apply(sapply(dcas16[, c("educ", "dem.income.cat4")], is.na), 2, sum)
    mi18 <- apply(sapply(dcas18[, c("educ", "income")], is.na), 2, sum)
    
    tibble(
        year = c("2016", "2018"),
        educ_mi = c(mi16[1], mi18[1]),
        educ_pct = round(c(mi16[1]/nrow(dcas16), mi18[1]/nrow(dcas18))*100, 1),
        inc_mi = c(mi16[2], mi18[2]),
        inc_pct = round(c(mi16[2]/nrow(dcas16), mi18[2]/nrow(dcas18))*100, 1)
    )

    ```
## Number of respondents by race 

Table \@ref(tab:racecount) shows the number of respondents in 2016 and 2018.

```{r surveys-race-counts}
racecnt18 <- dcas18svy$designs[[1]]$variables %>%
  group_by(raceeth) %>%
  count() %>%
  rename(`2018` = n)

dcas16svy$designs[[1]]$variables %>%
  group_by(raceeth) %>%
  count() %>%
  rename(`2016` = n) %>%
  full_join(racecnt18, by = "raceeth") %>%
  as_huxtable() %>%
  set_caption(
    "Number of respondents by race in DCAS 2016 and DCAS 2018 surveys"
  ) %>%
  set_label("tab:racecount")

```

## Assign labels to be used throughout analyses

```{r assign-labels}    
## Race labels and variable levels
racelabs <- c("Asian", "Black", "Latino", "White")
racelevs <- c("all", "asian", "black", "latino", "white")

## Labels for regression tables
regression_labels <- c('Asian','Black','Latinx',
                       'Age','Foreign Born','Male',
                       'Children Present', 'Married',
                       levels(dcas16$dem.educ.attain)[c(1,3:5)],
                       # levels(dcas$dem.income.cat4)[c(1,3:4)],
                       'Home owner',
                       'Years in neighborhood',
                       '10-50 blocks', '>50 blocks')

```
