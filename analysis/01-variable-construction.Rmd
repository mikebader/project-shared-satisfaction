# Subset Data
```{r subset-data}
rm(list=ls())
dataDIR <- '~/work/data/dcas/dcas2016/'
load(paste0(dataDIR,'Dataset/R/DCAS_2016_weighted.Rdata'))

dcas$quad <- dcas$neighborhood=='Global Neighborhood'
table(dcas[,c('neighborhood','quad')])
dcas <- dcas[!is.na(dcas$dem.race) & dcas$quad==TRUE,]
N <- sum(!is.na(dcas$dem.race))
```

Keep only respondents who live in quadrivial neighborhoods and who answered the question about race from the entire DCAS dataset (which also includes residents from disproportionately Latino neighborhoods in the DC area). 

The resulting dataset includes `r N` respondents.

# Variable Construction 

## Dependent Variables
### Satisfaction Variable
The current neighborhood satisfaction variable (`satisfied`) comes from Question 5: "How satisfied are you with your neighborhood as a place to live?" Responses of "Extremely satisfied" and "Very satisfied" are coded as "satisfied" (`1`); other responses ("Somewhat satisfied" and "Not at all satisfied" and coded as "unsatisfied" [`0`]). 

### Neighborhood Change Variable
The satisfaction with neighborhood change variable (`better`) comes from Question 9: "Looking back over the past five years or so, would you say that your neighborhood has:" Response options "Become a much better place to live" and "Become a somewhat better place to live" are coded as "better" (`1`) and the other three responses are coded as "not better" (`0`). 

```{r dependent-variables}
dcas$satisfied <- dcas$nhd.satisfaction %in% c(
                       'Extremely satisfied','Very satisfied')
table(dcas[, c('nhd.satisfaction','satisfied')])
dcas$extremely_satisfied <- as.numeric(dcas$nhd.satisfaction=='Extremely satisfied')
table(dcas[, c('nhd.satisfaction','extremely_satisfied')])

dcas$better <- dcas$nhd.change %in% c(
                       'Much better', 'Somewhat better')
table(dcas[, c('nhd.change','better')])
dcas$much_better <- dcas$nhd.change=='Much better'
table(dcas[, c('nhd.change','much_better')])
```

## Preferences for Other Communities
```{r rename-commvars}
## Change names to have search dimension first and commname second
## Help on regex part: https://stackoverflow.com/questions/952275/regex-group-capture-in-r-with-multiple-capture-groups
search.vars <- grep('nhd\\.srch.+\\.', names(dcas), value=TRUE)
new_search_matches <- regmatches(
    search.vars, regexec('nhd\\.srch\\.(.+)\\.(.+)$', search.vars))
new_search_names <- sapply(new_search_matches, function(x){
    paste(rev(x[2:3]), collapse='_')})
names(dcas)[names(dcas)%in%search.vars] <- new_search_names

# dcas$consider_num <- rowSums(dcas[grep('^cons_', names(dcas))])
# dcas$consider_any <- dcas$consider_num > 0
# dcas$notconsider_num <- rowSums(dcas[grep('^nc_', names(dcas))])
# dcas$notconsider_any <- dcas$notconsider_num >0
```
## Independent Variable
The independent variable for these analyses is self-identified race that has been recoded to represent non-Latinx white alone, non-Latinx black alone or in combination with other races, Latinx of any race, and non-Latinx Asian or Pacific Islander alone or in combination with any race except black. Respondents with other races were dropped from the analysis (N=`r N`). 

```{r independent-variables}
table(dcas$dem.race, useNA='always')
dcas$dem.race <- relevel(dcas$dem.race, ref='white')
```

## Control Variables
I included control variables in the models. All control variables were centered at their means. 

**Demographic characteristics**

* *Age*, calculated from answer to Question 49: "In what year were you born?"

* *Foreign born*, answer to Question 58: "Where were you born?"

* *Gender*, male or female

* *Kids*, if answer to Question 2--"How many children ages 17 or under live in your household?"--is greater than zero

* *Marital status*, if answer to Question 60--"What is your marital status"-- is "Now married or in a married-style arrangement"

```{r demographic-variables}

dcas$age <- dcas$dem.age
dcas$forborn <- dcas$dem.forborn
dcas$man <- dcas$dem.gender.mf=='Male'
dcas$kids <- as.numeric(as.character(dcas$q2)) > 0
dcas$kids[as.numeric(as.character(dcas$q2)) > 90] <- NA
dcas$married <- grepl("Now married", dcas$dem.marital.stat)
table(dcas[,c('dem.marital.stat','married')]) ##Check recoding
```
**Economic Status**

* *Educational attainment*, five categories based on Question 59, "What is the highest level of school you have completed or the highest degree you have received?"
* *Income*, four categories based on Question 64, "Last year, that is in 2015, what was your total family income from all sources before taxes?"

```{r economic-variables}
dcas$educ <- dcas$dem.educ.attain
educ_dummies <- paste0('educ',1:5)
dcas[,educ_dummies] <- lapply(1:5,
        function(i) {unclass(dcas$dem.educ.attain)==i})
for(i in 1:5) { ##Check recoding
    print(table(dcas[,c('dem.educ.attain',paste0('educ',i))]))
}
# educ_names <- levels(dcas$dem.educ.attain)
# educ_names[1] <- paste0("\\emph{Educational Attainment}&&\\\\", educ_names[1])

dcas$inc <- dcas$dem.income.cat4
inc_dummies <- paste0('inc',1:4)
dcas[,inc_dummies] <- lapply(1:4,
        function(i) {unclass(dcas$dem.income.cat4)==i})
for(i in 1:4) { ## Check recoding
    print(table(dcas[,c('dem.income.cat4',paste0('inc',i))]))
}
# inc_names <- sanitize(levels(dcas$dem.income.cat4))
# inc_names[1] <- paste0("\\emph{Income}&&\\\\", inc_names[1])
```

**Neighborhood Experience**

* *Years in neighborhood*, based on Question 4: "How many years have you lived in your current neighborhood?"

* *Neighborhood size*, based on Question 7: "How many blocks are in the area that you think of as your neighborhood?"

```{r nhood-variables}
dcas$nhdyrs <- as.numeric(as.character(dcas$q4))
dcas$nhdyrsc <- scale(dcas$nhdyrs, scale=FALSE)
qplot(dcas$nhdyrsc)

dcas$nhdsize[unclass(dcas$nhd.size)%in%c(1,2)] <- '1-9 blocks'
dcas$nhdsize[unclass(dcas$nhd.size)%in%c(3,4)] <- '10-50 blocks'
dcas$nhdsize[unclass(dcas$nhd.size)==5] <- '>50 blocks'
dcas$nhdsize <- ordered(dcas$nhdsize, 
                        levels=c('1-9 blocks', '10-50 blocks', '>50 blocks'))
table(dcas[,c('nhd.size', 'nhdsize')], useNA='always') ## Check recoding
```

**Centered Variables**

Create grand-mean centered variables.

```{r centering}
center <- function(x) { ## Function to mean-center but not scale vars
    scale(as.numeric(dcas[[x]]), scale=FALSE)
}
dcas$agec <- scale(dcas$dem.age, scale=FALSE)
dcas$forbornc <- center('dem.forborn')
dcas$manc <- center('man')
dcas$kidsc <- center('kids')
dcas$marriedc <- center('married')
dcas[,c(paste0(educ_dummies,'c'))] <- scale(dcas[,paste0('educ',1:5)], 
                                          scale=FALSE)
dcas[,c(paste0(inc_dummies, 'c'))] <- scale(dcas[,paste0('inc',1:4)],
                                         scale=FALSE)
```
