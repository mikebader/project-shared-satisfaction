# Supplement

## Data Construction
### Correlation of education and income:

```{r education-income-correlation, echo=TRUE, include=TRUE}
ggplot(dcas, aes(x=dem.income.cat4,y=dem.educ.attain)) + geom_jitter()
```

## Within Neighborhood Robustness Analysis

To address the concerns of reviewers that the findings reflect those whites willing to stay (or those who sought out diversity), I stratify models based on tertiles of the logged total change ratio in the white population from 2000 to 2015 (i.e., $\ln(POP_{2015}/POP_{2000}$). 

```{r supp-lntotchg-tertiles}
sampled_nhoods <- dcas16 %>%
    group_by(sample_tract) %>%
    slice(1L) %>%
    ungroup()

chgsum <- summary(sampled_nhoods$lntotchg)
chgtertiles <- quantile(sampled_nhoods$lntotchg, probs = seq(0, 1, 1/3))

```

I collapsed the dataset into a neighborhood-level dataset and then calculated tertiles of change based on the distribution of neighborhood white population change. The average neighborhood in the dataset kept `r round(exp(chgsum['Mean']), 2)*100` of its white residents (median = `r round(exp(chgsum['Median']), 2)*100`). The bands for the white population ratio in each tertile are: 

Tertile  Range of change ratio
-------- -------------------------------------------------------------------------
First    `r paste(sapply(chgtertiles[1:2], function(x) round(exp(x),2)), collapse ="-")`
Second   `r paste(sapply(chgtertiles[2:3], function(x) round(exp(x),2)), collapse ="-")` 
Third    `r paste(sapply(chgtertiles[3:4], function(x) round(exp(x),2)), collapse ="-")`

The distribution of neighborhood-level white population change can be seen in \@fig:supp-chgtert with the tertile breaks labeled in orange. 

```{r supp-chgtert, fig.cap="Distribution of neighborhood white population change"}
qplot(sampled_nhoods$lntotchg, bins=40) +
    geom_vline(aes(xintercept = chgtertiles[2:3]), color='orange') +
    scale_x_continuous(breaks=seq(-2,2,.5), limits=c(-1.75,1.75)) +
    labs(
        title='Distribution of logged population change ratio of whites',
        y = 'N',
        x = 'Logged white population change ratio'
    ) +
    theme_minimal()
```

Subset the DCAS 2016 data into three datasets, each containing data from one of the three tertiles. 

```{r supp-lntotchg-data}
dcas16svy <- dcas16svy %>%
    update(
        chgtert = factor(
                cut(lntotchg, breaks = chgtertiles, include.lowest = TRUE),
                labels = as.character(1:3)
            )
        )

svytert <- lapply(as.character(1:3), function(t){
    subset(dcas16svy, chgtert==t) %>%
        update(sample_tract = factor(as.character(sample_tract)))
})
```

Estimate model parameters and standard errors for the complete model and the model without race. These correspond to columns (2) and (3) in Table 6 of the manuscript (the strings stored in objects `m3` and `m4` contain the formulas for these two models). Report parameter estimates and standard errors into a table. 

```{r supp-lntotchg-analysis}
## Function to gather and tidy imputed results and report summary statistics
combine_tertiles <- function(res){
    lapply(res, function(res){
        cmb <- MIcombine_aic(res)
        nobs <- nrow(res[[1]]$data)
        cmb$nobs <- nobs
        return(cmb)
    })
}

## Estimate parameters of full model
m3tert <- lapply(svytert, function(svy){
    with(svy, svyglm(
        as.formula(paste('satisfied ~', m3)), family=binomial)
    )
})
m3comb <- combine_tertiles(m3tert)

## Estimate parameters of model without race
m4tert <- lapply(svytert, function(svy){
    with(svy, svyglm(
        as.formula(paste('satisfied ~', m4)), family=binomial)
    )
})
m4comb <- combine_tertiles(m4tert)

## Report models
chgtert_tbl <- report_models(
    m3comb[[1]], m4comb[[1]], m3comb[[2]], m4comb[[2]], m3comb[[3]], m4comb[[3]],
    caption = paste(
        "Logistic regression coefficients and standard errors predicted",
        "from models estimating neighborhood satisfaction among residents", 
        "of mulitracial neighborhoods by tertile of white population change"
        ),
    label = "tab:within",
    reglabels = regression_labels,
    use.headers = TRUE
)
statrow <- nrow(chgtert_tbl)-3
chgtert_tbl <- chgtert_tbl %>%
    insert_row(c("Tract fixed effects", rep("X", 6)),after=statrow) %>%
    set_top_border(statrow+1, everywhere, TRUE) %>%
    set_top_border(statrow+2, everywhere, FALSE) %>% 
    insert_row(c("", "First", "", "Second", "", "Third", ""), after=0) %>%
    merge_cells(1, c(2:3)) %>% 
    merge_cells(1, c(4:5)) %>%
    merge_cells(1, c(6:7)) %>%
    set_align(1, everywhere, 'center') %>%
    set_bottom_border(2, everywhere, TRUE) %>%
    set_top_padding(0) %>%
    set_bottom_padding(0)
chgtert_tbl[2,] <- c("", "(2)", "(3)", "(2)", "(3)", "(2)", "(3)")
gsub("```(.+\\n)?", "", to_latex(chgtert_tbl), perl=TRUE) %>% 
    cat(file="tables/within-by-change.tex")
chgtert_tbl

```

## Between Neighborhood Analysis

### Satisfaction in DC Area by neighborhood entropy

The following analysis examines whether neighborhood entropy predicts satisfaction among residents of the DC area broadly. The analysis uses the 2018 data and interacts neighborhood entropy by individual respondent race. 

```{r supp-entropy-dcas2018, warning=FALSE}
## Warnings are suppressed
## Define models and estimate parameters
m5bn <- paste(m3bn, "+ H*raceeth")

m518 <- with(dcas18svy, svyglm(
    as.formula(paste('satisfied ~', m5bn)), family=binomial)
    )

raceixn_labs <- c("", "x Asian", "x Black", "x Latinx")
entropy_tbl <- report_models(
    MIcombine_aic(m518), 
    reglabels = c(regression_labels,paste("Entropy", raceixn_labs)),
    caption = paste(
        "Logistic regression coefficients and standard errors predicted",
        "of models estimating neighborhood satisfaction among DC-area", 
        "residents including entropy index"
    ),
    label = "tbl:entropy"
)
entropy_tbl
```

### Differences in white population change between multiracial and other neighborhoods

Describe the different distributions of neighborhood change in the white population. \@ref(fig:supp-lntochg-plt) plots the distribution of the logged change ratio of whites in 2015 to whites in 2000. 

```{r supp-white-change}
stacked <- select(dcas16, lntotchg) %>% 
    mutate(year = 2016) %>%
    bind_rows(select(dcas18, lntotchg) %>% mutate(year = 2018))

kable(bind_rows(
    summary(dcas16$lntotchg[!is.infinite(dcas16$lntotchg)]),
    summary(dcas18$lntotchg[!is.infinite(dcas18$lntotchg)])
), digits = 2)

lntotchg_plt <- ggplot(stacked, aes(x=lntotchg)) +
    geom_histogram(binwidth=.125) +
    scale_x_continuous(limits = c(-3, 7.5), breaks=-7:7) +
    facet_wrap(~year, ncol = 1) +
    labs(
        title="Distribution of logged ratio of white population, 2015 to 2000",
        x = "Logged ratio of white change",
        y = "Count"
    ) +
    theme_minimal()

```

```{r supp-lntochg-plt, echo=FALSE, fig.cap="Distribution of logged ratio of white population, 2015 to 2000"}
lntotchg_plt
```

Examine the association between entropy and neighborhood satisfaction by race among the entire DC area population using the DCAS 2018 data. This provides a sense of whether residents respond to neighborhood diversity differently by race. 

```{r supp-lntotchg, warning=FALSE}
## Warnings are suppressed
## Create datasets that remove impossible values of lntotchg
dcas16svyln <- subset(dcas16svy, !is.infinite(lntotchg))
dcas18svyln <- subset(dcas18svy, !is.infinite(lntotchg))

mean18 <- with(dcas18svyln, svymean(~lntotchg)) %>% MIcombine() %>% coef()
var18  <- with(dcas18svyln, svyvar(~lntotchg)) %>% MIcombine() %>% coef()

dcas16svyln <- update(dcas16svyln, whiterat = (lntotchg - mean18)/var18)
dcas18svyln <- update(dcas18svyln, whiterat = (lntotchg - mean18)/var18)

## Estimate models of satisfaction with interactions by white change
m6bn <- paste(m3bn, "+ whiterat")
m7bn <- paste(m3bn, "+ whiterat*raceeth")

m616 <- with(dcas16svyln, svyglm(
    as.formula(paste('satisfied ~', m6bn)), family=binomial)
)
m716 <- with(dcas16svyln, svyglm(
    as.formula(paste('satisfied ~', m7bn)), family=binomial)
)

m618 <- with(dcas18svyln, svyglm(
    as.formula(paste('satisfied ~', m6bn)), family=binomial)
)
m718 <- with(dcas18svyln, svyglm(
    as.formula(paste('satisfied ~', m7bn)), family=binomial)
)

bn2018_supp_tbl <- report_models(
    MIcombine_aic(m616), MIcombine_aic(m716), 
    MIcombine_aic(m618), MIcombine_aic(m718),
    reglabels = c(regression_labels,
                  paste("Logged white change", raceixn_labs)),
    caption=paste(
        "Logistic regression coefficients and standard errors predicted",
        "of models estimating neighborhood satisfaction among", 
        "residents of multiracial neighborhoods and the DC-area, including",
        "logged change ratio of white population" 
    ),
    label="tbl:lnchgtot"
)
bn2018_supp_tbl

```

## Neighborhood Change Robustness Analysis

### Multinomial Logistic Regression of Neighborhood Change Questions
```{r improvement-analysis-multinomial}
library(svrepmisc)
des <- as.svrepdesign(svy$designs[[1]], type="bootstrap" , replicates=250)
m3m_bet <- svymultinom(as.formula(paste('nhd.change3 ~', m3)),
                       design = des)
tbl <- tidy(m3m_bet)[1:8,] %>%
    mutate(star = if_else(p.value < .001, '***',
                          if_else(p.value < .01, '**',
                                  if_else(p.value < 0.05, '*', ''))))
vals <- function(i) {
    c(sprintf("%5.3f", tbl[i,2]), sprintf("(%5.3f)", tbl[i,3]))
}

df <- tibble(
    Variable = c("Intercept", "", "Asian", "", "Black", "", "Latinx", ""),
    Better = c(sapply(seq(1, 7, 2), vals)),
    ` `  = c(sapply(tbl[seq(1, 7, 2), 6], c, "")),
    Worse  = c(sapply(seq(2, 8, 2), vals)),
    `  `  = c(sapply(tbl[seq(2, 8, 2), 6], c, ""))
)

kable(df, align = 'lrlrl', format = 'pandoc')
```

