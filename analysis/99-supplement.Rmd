# Supplement

## Data Construction
### Correlation of education and income:

```{r education-income-correlation, echo=TRUE, include=TRUE}
ggplot(dcas, aes(x=dem.income.cat4,y=dem.educ.attain)) + geom_jitter()
```

## Between Neighborhood Analysis

**TODO: Analyze regression of satisfaction in DCAS 2018 including entropy or HHI as a covariate in the model to test relationship of diversity to satisfaction.**

## Neighborhood Change Analysis
### Multinomial Logistic Regression of Neighborhood Change Questions
```{r improvement-analysis-multinomial}
library(svrepmisc)
des <- as.svrepdesign(svy$designs[[1]], type="bootstrap" , replicates=250)
m3m_bet <- svymultinom(as.formula(paste('nhd.change3 ~', m3)),
                       design = des)
tbl <- tidy(m3m_bet)[1:8,] %>%
    mutate(star = if_else(p.value < .001, '***',
                          if_else(p.value < .01, '**',
                                  if_else(p.value < 0.05, '*', ''))))
vals <- function(i) {
    c(sprintf("%5.3f", tbl[i,2]), sprintf("(%5.3f)", tbl[i,3]))
}

df <- tibble(
    Variable = c("Intercept", "", "Asian", "", "Black", "", "Latinx", ""),
    Better = c(sapply(seq(1, 7, 2), vals)),
    ` `  = c(sapply(tbl[seq(1, 7, 2), 6], c, "")),
    Worse  = c(sapply(seq(2, 8, 2), vals)),
    `  `  = c(sapply(tbl[seq(2, 8, 2), 6], c, ""))
)

kable(df, align = 'lrlrl', format = 'pandoc')
```


### Model of Neighborhood Improvement Including Neighborhood Satisfaction as a Variable

The following reports an analysis of neighborhood improvement that does not include neighborhood satisfaction as a covariate in the model.

```{r improvement-analysis-no-satisfaction}
m1_bet_alt <- with(dcassvy,
               svyglm(as.formula(paste('better ~', m1, '+ satisfied')),
                      family=binomial))
m1_bet_alt <- MIcombine_aic(m1_bet_alt)

m3_bet_alt <- with(dcassvy,
               svyglm(as.formula(paste('better ~', m3, '+ satisfied')),
                      family=binomial))
m3_bet_alt <- MIcombine_aic(m3_bet_alt)

m4_bet_alt <- with(dcassvy,
               svyglm(as.formula(paste('better ~ ', m4, '+ satisfied')),
                      family=binomial))
m4_bet_alt <- MIcombine_aic(m4_bet_alt)

bet_tbl_alt <- report_models(m1_bet_alt, m3_bet_alt, m4_bet_alt,
                         reglabels=c(regression_labels[1:3], 'Satisfied',
                                     regression_labels[-1:-3]),
                         caption=paste0('Estimated coefficients predicting ',
                                        'neighborhood improvement without satisfaction'),
                         label='tab:improvement-nosatisfaction')
bet_tbl_alt
cat(to_latex(bet_tbl_alt), file='tables/improvement-nosatisfaction.tex')
```


## Full Analytic Model, Don't Know About Communities
The following reports the full analytic model minus the coefficients and standard errors for neighborhood fixed effects (second and third models) predicting whether respondent doesn't know anything about the community.

```{r dont-know-supplement}
dk_out <- function(nhd) {
    dk_tbl <- huxreg(m0_dk[[nhd]], m1_dk[[nhd]], m3_dk[[nhd]])
    dk_tbl <- dk_tbl[c(-1*grep('^sample_tract', dk_tbl$names, perl=TRUE),
                       -1*(grep('^sample_tract', dk_tbl$names, perl=TRUE)+1)),
                     ] %>%
        set_caption(paste('Log-odds associated with not knowing anything about',
                          tools::toTitleCase(nhd))) %>%
        set_label(paste0('tbl:dk_',nhd))
    cat(to_latex(dk_tbl), file=paste0('tables/supplement/dont-know-',
                                      nhd,'.tex'))
}
dk_sup <- lapply(quad.nhoods, dk_out)
```

## Full Analytic Model, Knowing Friends or Family
The following reports the full analytic model minus the coefficients and standard errors for neighborhood fixed effects (second and third models) predicting whether respondent knew friends or family who lived in the neighborhood.

```{r friends-family-supplement}
ff_out <- function(nhd) {
    ff_tbl <- huxreg(m0_ff[[nhd]], m1_ff[[nhd]], m3_ff[[nhd]])
    ff_tbl <- ff_tbl[c(-1*grep('^sample_tract', ff_tbl$names, perl=TRUE),
                       -1*(grep('^sample_tract', ff_tbl$names, perl=TRUE)+1)),
                     ] %>%
        set_caption(paste('Log-odds associated with having friends or family in',
                          tools::toTitleCase(nhd))) %>%
        set_label(paste0('tbl:ff_',nhd))
    cat(to_latex(ff_tbl), file=paste0('tables/supplement/friends-family-',
                                      nhd,'.tex'))
}
ff_sup <- lapply(quad.nhoods, ff_out)
```

## Exploratory analysis examining influence of state of residence

* *State of residence*, factor variable indicating the state in which the respondent lives.
```{r residence-variables}
# dcas$state <- sapply(dcas$sample_tract, substr, start=1, stop=2)
# dcas$state[dcas$state=='24'] <- 'Maryland'
# dcas$state[dcas$state=='51'] <- 'Virginia'
# dcas$state <- factor(dcas$state)
```


## AIC of Knowledge & Consideration Models
```{r aic-know-consider}
m4_srch <- sub('dem\\.race \\+ ','', m3_srch)

## Don't Know
m4_dk <- lapply(quad.nhoods, nhd.model, 'dk', m4_srch)
names(m4_dk) <- quad.nhoods
m4_dk <- lapply(m4_dk, MIcombine_aic)

## Friends & Family
m4_ff <- lapply(quad.nhoods, nhd.model, 'ff', m4_srch)
names(m4_ff) <- quad.nhoods
m4_ff <- lapply(m4_ff, MIcombine_aic)

## Seriously Consider
m4_con <- lapply(quad.nhoods, nhd.model, 'cons', m4_srch)
names(m4_con) <- quad.nhoods
m4_con <- lapply(m4_con, MIcombine_aic)

## Never Consider
m4_nc <- lapply(quad.nhoods, nhd.model, 'nc', m4_srch)
names(m4_nc) <- quad.nhoods
m4_nc <- lapply(m4_nc, MIcombine_aic)
```

```{r}
res_m3 <- list(dk=m3_dk, ff=m3_ff, con=m3_con, nc=m3_nc)
res_m4 <- list(dk=m4_dk, ff=m4_ff, con=m4_con, nc=m4_nc)

aic.mat <- function(dim, res) {
    vals <- as.numeric(c(
        sapply(quad.nhoods, function(x) res_m3[[dim]][[x]]$aic[res]),
        sapply(quad.nhoods, function(x) res_m4[[dim]][[x]]$aic[res])
    ))
    assign('vals',vals,.GlobalEnv)
    if(res=='var') vals <- sqrt(vals)
    return(vals)
}

dims <- c('dk','ff','con','nc')

aics <- sapply(c('mean','var'), function(res) sapply(dims, aic.mat, res))
res <- data.frame(matrix(t(aics), nrow=6)) %>%
    round(2) %>%
    cbind()
tf <- sapply(c(2,4,6,8), function(x) res[,x] < res[,x-1])

aictbl <- cbind(res[,1:2], tf[,1])
aictbl <- cbind(aictbl, res[,3:4], tf[,2])
aictbl <- cbind(aictbl, res[,5:6], tf[,3])
aictbl <- cbind(aictbl, res[,7:8], tf[,4])
aictbl[c(2,4,6), c(3,6,9,12)] <- ''
aictbl <- cbind(as.vector(sapply(quad.nhoods, function(x) c(x, ''))), aictbl)
names(aictbl) <- c('Community', rep(c('Full', 'Reduced', 'R < F'), 4))

fname <- 'tables/supplement/aics.tex'
print.xtable(xtable(aictbl,
                    caption='Multiple imputation means and standard deviations of AIC values comparing full models to those not including race',
                    align=c('l', 'l', rep('R{5.5em}', 12)),
                    label='tab:aics'),
             booktabs = TRUE,
             floating.environment = 'sidewaystable',
             caption.placement = 'top',
             include.rownames = FALSE,
             file = fname,
             sanitize.text.function = identity,
             timestamp = '')
colsets <-  paste(
      '& \\multicolumn{3}{c}{\\strong{Don\'t Know}}'
    , '& \\multicolumn{3}{c}{\\strong{Friends \\& Family}}'
    , '& \\multicolumn{3}{c}{\\strong{Seriously Consider}}'
    , '& \\multicolumn{3}{c}{\\strong{Never Consider}} \\\\'
)
tbltxt <- readLines(fname)
ruleline <- grep('toprule', tbltxt)
tbltxt <- c(tbltxt[1:ruleline], colsets, tbltxt[(ruleline+1):length(tbltxt)])
writeLines(tbltxt, fname)
```

## Households with Children that Consider and Reject Communities by Race

```{r}
## Percent of race that considers & rejects communities by presence of
## children in household
kids.by.race <- function(nhd, dim) {
    f <- as.formula(paste('~nhd.srch', nhd, dim, sep='.'))
    res <- MIcombine(with(dcassvy, svyby(f, ~kids + dem.race, svymean)))
    res <- res$coefficients[grep('^TRUE.*TRUE$', names(res$coefficients))]
}

cons_vals <- sapply(quad.nhoods, kids.by.race, 'cons') %>%
    round(2) * 100
nc_vals <- sapply(quad.nhoods, kids.by.race, 'nc') %>%
    round(2) * 100

## Models of consideration and rejection interacting race and children present
m3_kr <- gsub('I\\(kids\\*1\\) \\+|\\n\\s+', '', m4_srch, perl=TRUE) %>%
    paste('+ dem.race * kids')

m3_conk <- lapply(quad.nhoods, nhd.model, 'cons', m3_kr)
names(m3_conk) <- quad.nhoods
m3_conk <- lapply(m3_conk, MIcombine_aic)

m3_nck <- lapply(quad.nhoods, nhd.model, 'nc', m3_kr)
names(m3_nck) <- quad.nhoods
m3_nck <- lapply(m3_nck, MIcombine_aic)

kr_labels <- c('Age', 'Foreign born', 'Man', 'Married',
               '<H.S.', 'Some college', 'B.A.', 'M.A.',
               regression_labels[1:3], 'Child present',
               paste(regression_labels[1:3], 'X child'))
fname = 'tables/supplement/race-kids-interactions.tex'
kr_tbl <- huxreg(append(m3_conk, m3_nck))
fe_rows <- grep('^sample', kr_tbl$names)
kr_tbl[1,] <- c('', rep(c('\tHerndon', '   German.','   Wheaton'), 2))
kr_tbl <- kr_tbl[-1*c(fe_rows, fe_rows+1),] %>%
    insert_row(c('',
                 'Seriously Consider', '', '',
                 'Never Consider','',''), after=0) %>%
    merge_cells(1, 2:4) %>% merge_cells(1, 5:7) %>%
    set_bottom_border(row=everywhere, col=everywhere, value =0) %>%
    set_top_border(row=everywhere, col=everywhere, value=0) %>%
    set_bottom_border(row=2, col=everywhere, value=1) %>%
    set_top_border(row=1, col=everywhere, value=1) %>%
    set_caption('Estimated coefficients and standard errors of model regressing consideration and rejection of communities interacting race with child presence') %>%
    set_label('tab:racekids')
kr_tbl[seq(5,length(kr_labels)*2+3, 2),1] <- kr_labels
kr_tbl <- kr_tbl[1:(nrow(kr_tbl)-3), ] %>%
    set_bottom_border(row=final(), col=everywhere, value=1)
kr_tbl

cat(to_latex(kr_tbl), file=fname)

tbltxt <- readLines(fname)
tbltxt <- gsub('\\{table\\}', '{sidewaystable}', tbltxt)
tbltxt <- gsub('\\multicolumn\\{1\\}\\{c', '\\multicolumn{1}{R{6.25em}', tbltxt)
tbltxt <- gsub('\\\\centering\\s+([H|G|W|\\\\])','\\1',tbltxt)
writeLines(tbltxt, fname)
```

```{r}
## Repeat the above WITHOUT fixed effects
m3_kr_nofe <- sub('sample_tract \\+', '', m3_kr)

m3_conk_nofe <- lapply(quad.nhoods, nhd.model, 'cons', m3_kr_nofe)
names(m3_conk_nofe) <- quad.nhoods
m3_conk_nofe <- lapply(m3_conk_nofe, MIcombine_aic)

m3_nck_nofe <- lapply(quad.nhoods, nhd.model, 'nc', m3_kr_nofe)
names(m3_nck_nofe) <- quad.nhoods
m3_nck_nofe <- lapply(m3_nck_nofe, MIcombine_aic)

fname = 'tables/supplement/race-kids-interactions-nofe.tex'
kr_tbl <- huxreg(append(m3_conk_nofe, m3_nck_nofe))
kr_tbl[1,] <- c('', rep(c('\tHerndon', '   German.','   Wheaton'), 2))
kr_tbl <- kr_tbl %>%
    insert_row(c('',
                 'Seriously Consider', '', '',
                 'Never Consider','',''), after=0) %>%
    merge_cells(1, 2:4) %>% merge_cells(1, 5:7) %>%
    set_bottom_border(row=everywhere, col=everywhere, value =0) %>%
    set_top_border(row=everywhere, col=everywhere, value=0) %>%
    set_bottom_border(row=2, col=everywhere, value=1) %>%
    set_top_border(row=1, col=everywhere, value=1) %>%
    set_caption('Estimated coefficients and standard errors of model regressing consideration and rejection of communities interacting race with child presence \\strong{without fixed effects}') %>%
    set_label('tab:racekids')
kr_tbl[seq(5,length(kr_labels)*2+3, 2),1] <- kr_labels
kr_tbl <- kr_tbl[1:(nrow(kr_tbl)-3), ] %>%
    set_bottom_border(row=final(), col=everywhere, value=1)
kr_tbl

cat(to_latex(kr_tbl), file=fname)

tbltxt <- readLines(fname)
tbltxt <- gsub('\\{table\\}', '{sidewaystable}', tbltxt)
tbltxt <- gsub('\\multicolumn\\{1\\}\\{c', '\\multicolumn{1}{R{6.25em}', tbltxt)
tbltxt <- gsub('\\\\centering\\s+([H|G|W|\\\\])','\\1',tbltxt)
writeLines(tbltxt, fname)
```
