# Supplement

## Data Construction
### Correlation of education and income:

```{r education-income-correlation, echo=TRUE, include=TRUE}
ggplot(dcas, aes(x=dem.income.cat4,y=dem.educ.attain)) + geom_jitter()
```

## Within Neighborhood Robustness Analysis

To address the concerns of reviewers that the findings reflect those whites willing to stay (or those who sought out diversity), I stratify models based on tertiles of the logged total change ratio in the white population from 2000 to 2015 (i.e., $\ln(POP_{2015}/POP_{2000}$). 

```{r supp-lntotchg-tertiles}
sampled_nhoods <- dcas16 %>%
    group_by(sample_tract) %>%
    slice(1L) %>%
    ungroup()

chgsum <- summary(sampled_nhoods$lntotchg)
chgtertiles <- quantile(sampled_nhoods$lntotchg, probs = seq(0, 1, 1/3))

```

I collapsed the dataset into a neighborhood-level dataset and then calculated tertiles of change based on the distribution of neighborhood white population change. The average neighborhood in the dataset kept `r round(exp(chgsum['Mean']), 2)*100` of its white residents (median = `r round(exp(chgsum['Median']), 2)*100`). The bands for the white population ratio in each tertile are: 

Tertile  Range of change ratio
-------- -------------------------------------------------------------------------
First    `r paste(sapply(chgtertiles[1:2], function(x) round(exp(x),2)), collapse ="-")`
Second   `r paste(sapply(chgtertiles[2:3], function(x) round(exp(x),2)), collapse ="-")` 
Third    `r paste(sapply(chgtertiles[3:4], function(x) round(exp(x),2)), collapse ="-")`

The distribution of neighborhood-level white population change can be seen in \@fig:supp-chgtert with the tertile breaks labeled in orange. 

```{r supp-chgtert, fig.cap="Distribution of neighborhood white population change"}
qplot(sampled_nhoods$lntotchg, bins=40) +
    geom_vline(aes(xintercept = chgtertiles[2:3]), color='orange') +
    scale_x_continuous(breaks=seq(-2,2,.5), limits=c(-1.75,1.75)) +
    labs(
        title='Distribution of logged population change ratio of whites',
        y = 'N',
        x = 'Logged white population change ratio'
    ) +
    theme_minimal()
```

Subset the DCAS 2016 data into three datasets, each containing data from one of the three tertiles. 

```{r supp-lntotchg-data}
dcas16svy <- dcas16svy %>%
    update(
        chgtert = factor(
                cut(lntotchg, breaks = chgtertiles, include.lowest = TRUE),
                labels = as.character(1:3)
            )
        )

svytert <- lapply(as.character(1:3), function(t){
    subset(dcas16svy, chgtert==t) %>%
        update(sample_tract = factor(as.character(sample_tract)))
})
```

Estimate model parameters and standard errors for the complete model and the model without race. These correspond to columns (2) and (3) in Table 6 of the manuscript (the strings stored in objects `m3` and `m4` contain the formulas for these two models). Report parameter estimates and standard errors into a table. 

```{r supp-lntotchg-analysis}
## Function to gather and tidy imputed results and report summary statistics
combine_tertiles <- function(res){
    lapply(res, function(res){
        cmb <- MIcombine_aic(res)
        nobs <- nrow(res[[1]]$data)
        cmb$nobs <- nobs
        return(cmb)
    })
}

## Estimate parameters of full model
m3tert <- lapply(svytert, function(svy){
    with(svy, svyglm(
        as.formula(paste('satisfied ~', m3)), family=binomial)
    )
})
m3comb <- combine_tertiles(m3tert)

## Estimate parameters of model without race
m4tert <- lapply(svytert, function(svy){
    with(svy, svyglm(
        as.formula(paste('satisfied ~', m4)), family=binomial)
    )
})
m4comb <- combine_tertiles(m4tert)

## Report models
chgtert_tbl <- report_models(
    m3comb[[1]], m4comb[[1]], m3comb[[2]], m4comb[[2]], m3comb[[3]], m4comb[[3]],
    caption = paste(
        "Logistic regression coefficients and standard errors predicted",
        "from models estimating neighborhood satisfaction among residents", 
        "of mulitracial neighborhoods by tertile of white population change"
        ),
    label = "tab:within",
    reglabels = regression_labels,
    use.headers = TRUE
)
statrow <- nrow(chgtert_tbl)-3
chgtert_tbl <- chgtert_tbl %>%
    insert_row(c("Tract fixed effects", rep("X", 6)),after=statrow) %>%
    set_top_border(statrow+1, everywhere, TRUE) %>%
    set_top_border(statrow+2, everywhere, FALSE) %>% 
    insert_row(c("", "First", "", "Second", "", "Third", ""), after=0) %>%
    merge_cells(1, c(2:3)) %>% 
    merge_cells(1, c(4:5)) %>%
    merge_cells(1, c(6:7)) %>%
    set_align(1, everywhere, 'center') %>%
    set_bottom_border(2, everywhere, TRUE) %>%
    set_top_padding(0) %>%
    set_bottom_padding(0)
chgtert_tbl[2,] <- c("", "(2)", "(3)", "(2)", "(3)", "(2)", "(3)")
gsub("```(.+\\n)?", "", to_latex(chgtert_tbl), perl=TRUE) %>% 
    cat(file="tables/within-by-change.tex")
chgtert_tbl

```

The second robustness analysis considers length of residence in neighborhoods by race. Figure \@ref(fig:supp-nhdyrs-race) plots the distribution of years lived in their current neighborhood by the race of the respondent. Whites exclusively account for residents who have lived in neighborhoods longer than 40 years. Yet most respondents, *even half of white respondents*, moved into their neighborhoods in the past 10 years. 

```{r supp-nhdyrs-race, fig.cap="Distribution of years lived in current neighborhood by race"}
names(racelabs) <- racelevs[-1]
nhdyrs_race_plt <- ggplot(filter(dcas16, !is.na(raceeth)), aes(x=nhdyrs)) +
    geom_bar() +
    scale_x_continuous(breaks = seq(0, 60, 5)) +
    facet_wrap(~raceeth, ncol=1, labeller = labeller(raceeth = racelabs)) +
    labs(
        title = "Distribution of years lived in current neighborhood by race",
        x = "Years lived in neighborhood"
    ) +
    theme_minimal()
nhdyrs_race_plt
```

```{r supp-nhdyrs-race-tbl, echo=FALSE}
dcas16svy <- dcas16svy %>%
    update(nhdyrscat = cut(nhdyrs, 
                           breaks=c(0,10,20,30,40,60), include.lowest = TRUE))
tbl <- with(dcas16svy,
            svyby(~nhdyrscat, ~raceeth, svymean))%>%
    MIcombine() %>% 
    coef() %>%
    matrix(nrow=4, byrow=FALSE)
rownames(tbl) <- racelabs[c(4, 1:3)]
colnames(tbl) <- levels(dcas16svy$designs[[1]]$variables$nhdyrscat)

kable(tbl, 
      caption="Years lived in current neighborhood by race",
      label = 'tbl:nhdyrs-race')
```

Figure \@ref(fig:supp-satisfied-years-whites) shows the (unweighted) smoothed percent of white residents satisified by length of residence in their neighborhoods. Just under 70 percent of whites who lived in the neighborhood fewer than 40 years reported being satisfied, with a possible modest increase among those who lived in the neighborhood from 20 to 40 years. A consistent downward trend existed among the five percent of white residents who lived in the neighborhood for at least 40 years (but even then, more of those residents were satisfied than dissatisfied). 

```{r supp-satisfied-years-whites, fig.cap="Percent (unweighted) of white residents reporting being satisfied in multiracial neighborhoods by length of residence in neighborhoods"}
nhwsat_nhdyrs_fig <- ggplot(filter(dcas16, raceeth=='white'), 
       aes(x=nhdyrs, y=satisfied)) +
    geom_smooth(color='#333333') +
    scale_x_continuous(breaks=seq(0,60,10)) +
    scale_y_continuous(breaks=seq(0.2,1.0,0.1)) +
    theme_minimal()
nhwsat_nhdyrs_fig 

```

Recent white newcomers are not more satisfied than current white residents, a pattern that we would have expected if diversity-seeking whites entered multiracial neighborhoods filled with existing dissatisfied whites. Similarly, we do not see satisfaction decline among white residents who lived in the neighborhood longer, at least among those who lived in neighborhoods less than 40 years. 

The descriptive plot above does not, however, account for other factors that might correlate with satisfaction and length of residents, especially age, which mechanically correlates with length of residence. I created models that include a categorical variable for how long respondents have lived in multiracial neighborhoods and estimated parameters based only among white respondents. 

```{r supp-nhwsat-nhdyrs, warning=FALSE}
## Warnings are suppressed
## Subset data to include only white respondents
dcas16nhw <- subset(dcas16svy, raceeth=='white')

## Estimate model with fixed effects
m3yrs <- sub('nhdyrsc', 'nhdyrscat', m3) 
m3yrs <- sub('raceeth \\+', '', m3yrs)
m3nhwyrs <- with(dcas16nhw, svyglm(
    as.formula(paste('satisfied ~', m3yrs)), family=binomial)
)

m3yrs_wo <- sub('nhdyrscat \\+', '', m3yrs)
m3nhwyrs_wo <- with(dcas16nhw, svyglm(
    as.formula(paste('satisfied ~', m3yrs_wo)), family=binomial)
)

## Estimate model without fixed effects
m3yrs_nofe <- sub('sample_tract +', '', m3yrs)
m3nhwyrs_nofe <- with(dcas16nhw, svyglm(
    as.formula(paste('satisfied ~', m3yrs_nofe)), family=binomial)
)

m3yrs_nofe_wo <- sub('nhdyrscat \\+', '', m3yrs_nofe)
m3nhwyrs_nofe_wo <- with(dcas16nhw, svyglm(
    as.formula(paste('satisfied ~', m3yrs_nofe_wo)), family=binomial)
)


```

The results of these models are reported below. The first two columns estimated models with neighborhood fixed effects, meaning the models statistically compare white residents living in the same neighborhood. The first column shows that length of residence *does not* predict satisfaction among whites. The coefficients for residents who lived longer in their neighborhoods were negative, but the standard errors were double the estimated point estimate for two of three cases and as large as the point estimate for the third. What is more, the AIC for the estimated model without length of residence, reported at the bottrom of the second column, was smaller than the model that included length of residence; the data fit the model without length of residence better than the model that included length of residence. 

```{r supp-nhwsat-nhdyrs-tbl, echo=FALSE}
yearlabs <- paste(
    c("11-20", "21-30", "31-40", ">40"), 
    "years in neighborhood"
)
nhwyrs_labels <- c(regression_labels[4:13], yearlabs,
                   regression_labels[15:16])
nhwyrs_tbl <- report_models(
    MIcombine_aic(m3nhwyrs), MIcombine_aic(m3nhwyrs_wo), 
    MIcombine_aic(m3nhwyrs_nofe), MIcombine_aic(m3nhwyrs_nofe_wo),
    reglabels = nhwyrs_labels,
    caption = paste(
        "Logistic regression coefficients and standard errors predicted",
        "of models estimating neighborhood satisfaction among white", 
        "residents of multiracial neighborhoods"
        ),
    label = 'tbl:nhw-years'
)
section_headers <- c('Demographics', 'Education', 'Neighborhood perceptions')
nhwyrs_tbl <- nhwyrs_tbl %>%
    insert_row(c('Demographics', '', '', '', ''),
                after=(which(nhwyrs_tbl$names=='(Intercept)')+1)) %>%
    insert_row(c('Education', '', '', '', ''),
               after=(which(nhwyrs_tbl$names=='Married')+2)) %>%
    insert_row(c('Neighborhood perceptions', '', '', '', ''),
               after=(which(nhwyrs_tbl$names=='M.A.+')+3)) %>%
    insert_row(c('Neighborhood Fixed Effects', 'X', 'X', '', ''),
               after=(which(nhwyrs_tbl$names=='>50 blocks')+4))
nhwyrs_tbl <- set_italic(nhwyrs_tbl, 
                         which(nhwyrs_tbl$names %in% section_headers), everywhere, TRUE)

nhwyrs_tbl[1,] <- c('', '(1)', '(2)', '(1)', '(2)') 
nhwyrs_tbl

```

The third and fourth columns report analogous models without fixed effects. Removing the fixed effects (and not including any neighborhood covariates) allowed me to examine whether the duration of residence between any two white residents randomly drawn from any multiracial neighborhood in the DC Area differ from one another. Since we would expect neighborhood conditions to exert a strong influence on mobility decisions, then not accounting for neighborhood differences provides a conservative estimate regarding whether length of residence influences satisfaction among whites. Yet, again, none of the coefficients can be distinguished from a null association and the data fit the model without length of residence better than the model with length of residence. 

## Between Neighborhood Analysis

### Satisfaction in DC Area by neighborhood entropy

The following analysis examines whether neighborhood entropy predicts satisfaction among residents of the DC area broadly. The analysis uses the 2018 data and interacts neighborhood entropy by individual respondent race. 

```{r supp-entropy-dcas2018, warning=FALSE}
## Warnings are suppressed
## Define models and estimate parameters
m5bn <- paste(m3bn, "+ H*raceeth")

m518 <- with(dcas18svy, svyglm(
    as.formula(paste('satisfied ~', m5bn)), family=binomial)
    )

raceixn_labs <- c("", "x Asian", "x Black", "x Latinx")
entropy_tbl <- report_models(
    MIcombine_aic(m518), 
    reglabels = c(regression_labels,paste("Entropy", raceixn_labs)),
    caption = paste(
        "Logistic regression coefficients and standard errors predicted",
        "of models estimating neighborhood satisfaction among DC-area", 
        "residents including entropy index"
    ),
    label = "tbl:entropy"
)
entropy_tbl
```

### Differences in white population change between multiracial and other neighborhoods

Describe the different distributions of neighborhood change in the white population. \@ref(fig:supp-lntochg-plt) plots the distribution of the logged change ratio of whites in 2015 to whites in 2000. 

```{r supp-white-change}
stacked <- select(dcas16, lntotchg) %>% 
    mutate(year = 2016) %>%
    bind_rows(select(dcas18, lntotchg) %>% mutate(year = 2018))

kable(bind_rows(
    summary(dcas16$lntotchg[!is.infinite(dcas16$lntotchg)]),
    summary(dcas18$lntotchg[!is.infinite(dcas18$lntotchg)])
), digits = 2)

lntotchg_plt <- ggplot(stacked, aes(x=lntotchg)) +
    geom_histogram(binwidth=.125) +
    scale_x_continuous(limits = c(-3, 7.5), breaks=-7:7) +
    facet_wrap(~year, ncol = 1) +
    labs(
        title="Distribution of logged ratio of white population, 2015 to 2000",
        x = "Logged ratio of white change",
        y = "Count"
    ) +
    theme_minimal()

```

```{r supp-lntochg-plt, echo=FALSE, fig.cap="Distribution of logged ratio of white population, 2015 to 2000"}
lntotchg_plt
```

Examine the association between entropy and neighborhood satisfaction by race among the entire DC area population using the DCAS 2018 data. This provides a sense of whether residents respond to neighborhood diversity differently by race. 

```{r supp-lntotchg, warning=FALSE}
## Warnings are suppressed
## Create datasets that remove impossible values of lntotchg
dcas16svyln <- subset(dcas16svy, !is.infinite(lntotchg))
dcas18svyln <- subset(dcas18svy, !is.infinite(lntotchg))

mean18 <- with(dcas18svyln, svymean(~lntotchg)) %>% MIcombine() %>% coef()
var18  <- with(dcas18svyln, svyvar(~lntotchg)) %>% MIcombine() %>% coef()

dcas16svyln <- update(dcas16svyln, whiterat = (lntotchg - mean18)/var18)
dcas18svyln <- update(dcas18svyln, whiterat = (lntotchg - mean18)/var18)

## Estimate models of satisfaction with interactions by white change
m6bn <- paste(m3bn, "+ whiterat")
m7bn <- paste(m3bn, "+ whiterat*raceeth")

m616 <- with(dcas16svyln, svyglm(
    as.formula(paste('satisfied ~', m6bn)), family=binomial)
)
m716 <- with(dcas16svyln, svyglm(
    as.formula(paste('satisfied ~', m7bn)), family=binomial)
)

m618 <- with(dcas18svyln, svyglm(
    as.formula(paste('satisfied ~', m6bn)), family=binomial)
)
m718 <- with(dcas18svyln, svyglm(
    as.formula(paste('satisfied ~', m7bn)), family=binomial)
)

bn2018_supp_tbl <- report_models(
    MIcombine_aic(m616), MIcombine_aic(m716), 
    MIcombine_aic(m618), MIcombine_aic(m718),
    reglabels = c(regression_labels,
                  paste("Logged white change", raceixn_labs)),
    caption=paste(
        "Logistic regression coefficients and standard errors predicted",
        "of models estimating neighborhood satisfaction among", 
        "residents of multiracial neighborhoods and the DC-area, including",
        "logged change ratio of white population" 
    ),
    label="tbl:lnchgtot"
)
bn2018_supp_tbl

```

## Neighborhood Change Robustness Analysis

### Multinomial Logistic Regression of Neighborhood Change Questions
```{r improvement-analysis-multinomial}
library(svrepmisc)
des <- as.svrepdesign(svy$designs[[1]], type="bootstrap" , replicates=250)
m3m_bet <- svymultinom(as.formula(paste('nhd.change3 ~', m3)),
                       design = des)
tbl <- tidy(m3m_bet)[1:8,] %>%
    mutate(star = if_else(p.value < .001, '***',
                          if_else(p.value < .01, '**',
                                  if_else(p.value < 0.05, '*', ''))))
vals <- function(i) {
    c(sprintf("%5.3f", tbl[i,2]), sprintf("(%5.3f)", tbl[i,3]))
}

df <- tibble(
    Variable = c("Intercept", "", "Asian", "", "Black", "", "Latinx", ""),
    Better = c(sapply(seq(1, 7, 2), vals)),
    ` `  = c(sapply(tbl[seq(1, 7, 2), 6], c, "")),
    Worse  = c(sapply(seq(2, 8, 2), vals)),
    `  `  = c(sapply(tbl[seq(2, 8, 2), 6], c, ""))
)

kable(df, align = 'lrlrl', format = 'pandoc')
```

