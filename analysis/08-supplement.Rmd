# Supplement

## Correlation of education and income: 

```{r education-income-correlation, echo=TRUE, include=TRUE}
ggplot(dcas, aes(x=dem.income.cat4,y=dem.educ.attain)) + geom_jitter()
```



## Model of Neighborhood Improvement Including Neighborhood Satisfaction as a Variable

The following reports an analysis of neighborhood improvement that does not include neighborhood satisfaction as a covariate in the model. 

```{r improvement-analysis-no-satisfaction}
m1_bet_alt <- with(dcassvy,
               svyglm(as.formula(paste('better ~', m1, '+ satisfied')), 
                      family=binomial))
m1_bet_alt <- MIcombine_aic(m1_bet_alt)

m3_bet_alt <- with(dcassvy,
               svyglm(as.formula(paste('better ~', m3, '+ satisfied')),
                      family=binomial))
m3_bet_alt <- MIcombine_aic(m3_bet_alt)

m4_bet_alt <- with(dcassvy,
               svyglm(as.formula(paste('better ~ ', m4, '+ satisfied')),
                      family=binomial))
m4_bet_alt <- MIcombine_aic(m4_bet_alt)

bet_tbl_alt <- report_models(m1_bet_alt, m3_bet_alt, m4_bet_alt,
                         reglabels=c(regression_labels[1:3], 'Satisfied',
                                     regression_labels[-1:-3]),
                         caption=paste0('Estimated coefficients predicting ',
                                        'neighborhood improvement without satisfaction'),
                         label='tab:improvement-nosatisfaction')
bet_tbl_alt
cat(to_latex(bet_tbl_alt), file='tables/improvement-nosatisfaction.tex')
```
## Full Analytic Model, Don't Know About Communities
The following reports the full analytic model minus the coefficients and standard errors for neighborhood fixed effects (second and third models) predicting whether respondent doesn't know anything about the community. 

```{r dont-know-supplement}
dk_out <- function(nhd) {
    dk_tbl <- huxreg(m0_dk[[nhd]], m1_dk[[nhd]], m3_dk[[nhd]])
    dk_tbl <- dk_tbl[c(-1*grep('^sample_tract', dk_tbl$names, perl=TRUE),
                       -1*(grep('^sample_tract', dk_tbl$names, perl=TRUE)+1)),
                     ] %>%
        set_caption(paste('Log-odds associated with not knowing anything about',
                          tools::toTitleCase(nhd))) %>%
        set_label(paste0('tbl:dk_',nhd))
    cat(to_latex(dk_tbl), file=paste0('tables/supplement/dont-know-',
                                      nhd,'.tex'))
}
dk_sup <- lapply(quad.nhoods, dk_out)
```

## Full Analytic Model, Knowing Friends or Family
The following reports the full analytic model minus the coefficients and standard errors for neighborhood fixed effects (second and third models) predicting whether respondent knew friends or family who lived in the neighborhood.

```{r friends-family-supplement}
ff_out <- function(nhd) {
    ff_tbl <- huxreg(m0_ff[[nhd]], m1_ff[[nhd]], m3_ff[[nhd]])
    ff_tbl <- ff_tbl[c(-1*grep('^sample_tract', ff_tbl$names, perl=TRUE),
                       -1*(grep('^sample_tract', ff_tbl$names, perl=TRUE)+1)),
                     ] %>%
        set_caption(paste('Log-odds associated with having friends or family in',
                          tools::toTitleCase(nhd))) %>%
        set_label(paste0('tbl:ff_',nhd))
    cat(to_latex(ff_tbl), file=paste0('tables/supplement/friends-family-',
                                      nhd,'.tex'))
}
ff_sup <- lapply(quad.nhoods, ff_out)
```

## Exploratory analysis examining influence of state of residence

* *State of residence*, factor variable indicating the state in which the respondent lives.  
```{r residence-variables}
# dcas$state <- sapply(dcas$sample_tract, substr, start=1, stop=2)
# dcas$state[dcas$state=='24'] <- 'Maryland'
# dcas$state[dcas$state=='51'] <- 'Virginia'
# dcas$state <- factor(dcas$state)
```


## AIC of Knowledge & Consideration Models
```{r aic-know-consider}
m4_srch <- sub('dem\\.race \\+ ','', m3_srch)

## Don't Know
m4_dk <- lapply(quad.nhoods, nhd.model, 'dk', m4_srch)
names(m4_dk) <- quad.nhoods
m4_dk <- lapply(m4_dk, MIcombine_aic)

## Friends & Family 
m4_ff <- lapply(quad.nhoods, nhd.model, 'ff', m4_srch)
names(m4_ff) <- quad.nhoods
m4_ff <- lapply(m4_ff, MIcombine_aic)

## Seriously Consider
m4_con <- lapply(quad.nhoods, nhd.model, 'cons', m4_srch)
names(m4_con) <- quad.nhoods
m4_con <- lapply(m4_con, MIcombine_aic)

## Never Consider
m4_nc <- lapply(quad.nhoods, nhd.model, 'nc', m4_srch)
names(m4_nc) <- quad.nhoods
m4_nc <- lapply(m4_nc, MIcombine_aic)
```

```{r}
res_m3 <- list(dk=m3_dk, ff=m3_ff, con=m3_con, nc=m3_nc)
res_m4 <- list(dk=m4_dk, ff=m4_ff, con=m4_con, nc=m4_nc)

aic.mat <- function(dim, res) {
    vals <- as.numeric(c(
        sapply(quad.nhoods, function(x) res_m3[[dim]][[x]]$aic[res]),
        sapply(quad.nhoods, function(x) res_m4[[dim]][[x]]$aic[res])
    ))
    assign('vals',vals,.GlobalEnv)
    if(res=='var') vals <- sqrt(vals)
    return(vals)
}

dims <- c('dk','ff','con','nc')

aics <- sapply(c('mean','var'), function(res) sapply(dims, aic.mat, res))
res <- data.frame(matrix(t(aics), nrow=6)) %>%
    round(2) %>%
    cbind()
tf <- sapply(c(2,4,6,8), function(x) res[,x] < res[,x-1])

aictbl <- cbind(res[,1:2], tf[,1])
aictbl <- cbind(aictbl, res[,3:4], tf[,2])
aictbl <- cbind(aictbl, res[,5:6], tf[,3])
aictbl <- cbind(aictbl, res[,7:8], tf[,4])
aictbl[c(2,4,6), c(3,6,9,12)] <- ''
aictbl <- cbind(as.vector(sapply(quad.nhoods, function(x) c(x, ''))), aictbl)
names(aictbl) <- c('Community', rep(c('Full', 'Reduced', 'R < F'), 4))

fname <- 'tables/supplement/aics.tex'
print.xtable(xtable(aictbl,
                    caption='Multiple imputation means and standard deviations of AIC values comparing full models to those not including race',
                    align=c('l', 'l', rep('R{5.5em}', 12)),
                    label='tab:aics'),
             booktabs = TRUE,
             floating.environment = 'sidewaystable',
             caption.placement = 'top',
             include.rownames = FALSE,
             file = fname,
             sanitize.text.function = identity,
             timestamp = '')
colsets <-  paste(
      '& \\multicolumn{3}{c}{\\strong{Don\'t Know}}'
    , '& \\multicolumn{3}{c}{\\strong{Friends \\& Family}}'
    , '& \\multicolumn{3}{c}{\\strong{Seriously Consider}}'
    , '& \\multicolumn{3}{c}{\\strong{Never Consider}} \\\\'
)
tbltxt <- readLines(fname)
ruleline <- grep('toprule', tbltxt)
tbltxt <- c(tbltxt[1:ruleline], colsets, tbltxt[(ruleline+1):length(tbltxt)])
writeLines(tbltxt, fname)

    



``` 
