# Data Construction

Data for this manuscript come from the 2016 DC Area Survey. More information about the 2016 DC Area Survey can be found [here](http://bit.ly/dcas2016).

```{r load-data}
dataDIR <- '~/work/data/dcas/dcas2016/'
load(paste0(dataDIR,'Dataset/R/DCAS_2016_weighted.Rdata'))

```

## Respondent Selection

**Respondents Living in Multiracial Neighborhoods.** The DCAS 2016 data represent two populations: those living in multiracial neighborhoods and those living in disproportionately Latino neighborhoods. This manuscript only used data from the multiracial neighborhoods. I create a variable `quad` to represent these variables ('quad' comes from my [previous description](http://bit.ly/nhoodTrajPaper) of stable multiracial neighborhoods as 'quadrivial neighborhoods').

**///////**

**NOTE: NEED TO SUBSET DATA USING SURVEY COMMAND**

**///////**

```{r subset-data}
dcas$quad <- dcas$neighborhood=='Global Neighborhood'
table(dcas[,c('neighborhood','quad')])
N_norace <- sum(is.na(dcas$dem.race) & dcas$quad==TRUE)
dcas <- dcas[!is.na(dcas$dem.race) & dcas$quad==TRUE,]
dcas$sample_tract <- droplevels(dcas$sample_tract)
N_quad <- length(dcas$studycase)
N <- sum(!is.na(dcas$dem.race))
texcmds[['N']] <- N
```


## Variable Construction



### Dependent Variables

**Neighborhood Satisfaction.** Create neighborhood satisfaction variable (`satisfied`) to represent responses of "Extremely Satisfied" or "Very Satisfied". Check that the variable was created correctly.
```{r variables-satisfied}
dcas$satisfied <- dcas$nhd.satisfaction %in% c(
                       'Extremely satisfied','Very satisfied')*1
table(dcas[, c('nhd.satisfaction','satisfied')])

## Extremely satisfied (not used in the analysis)
dcas$extremely_satisfied <- as.numeric(dcas$nhd.satisfaction=='Extremely satisfied')*1
table(dcas[, c('nhd.satisfaction','extremely_satisfied')])

```

**Neighborhood improvement.** Create variable (`better`) measuring whether respondent perceives that the neighborhood has improved. Include responses "Much better" and "Somewhat better". Check that variable was created correctly.
```{r variables-better}
dcas$better <- dcas$nhd.change %in% c(
                       'Much better', 'Somewhat better')*1
table(dcas[, c('nhd.change','better')])

## Much better (not used in the analysis)
dcas$much_better <- (dcas$nhd.change=='Much better')*1
table(dcas[, c('nhd.change','much_better')])

```

**Community Unfamiliarity and Perceptions.** 

*Identify Communities for Inclusion.* Identify communities that meet threshold for inclusion based on racial compositions. Load preference-level dataset ("long" dataset with five dimensions per person), then limit to one observation per community.

```{r variables-comms-id}
load(paste0(dataDIR, 'dataset/R/DCAS_2016_PreferenceLevel.Rdata'))
racecomp <- paste0('pct', c('nhw','api','nhb','lat'))
comms <- dcas_prefs[!duplicated(dcas_prefs$commname),
                    c('commname', racecomp)]
```

Find communities that meet racial composition criteria. Save list of variable names for each dimension of those communities. Check inclusion criteria.
```{r variables-comms-id2}
quadcomms <- comms[
    apply(comms[,c('pctnhw','pctapi','pctnhb','pctlat')]>=10, 1, all),
    'commname']

## List community names that meet criteria
quadcomms   

## Check that communities match criteria
comms[comms$commname %in% quadcomms, ] 
```

*List of search dimension variables.* Create list of variable names measuring responses to each qualifing community for each dimension of study:

1. Don't know anything about the community
2. Have friends or family living in the community
3. Would seriously consider moving to the community
4. Would never consider moving to the community
5. Lives in the community 

```{r variables-comms-id3}
## Create vector of variable names
commvars <- c(paste0('nhd.srch.',quadcomms,'.dk'),
              paste0('nhd.srch.',quadcomms,'.ff'),
              paste0('nhd.srch.',quadcomms,'.cons'),
              paste0('nhd.srch.',quadcomms,'.nc'),
              paste0('nhd.srch.',quadcomms,'.live'))
commvars

```

<!-- ## Preferences for Other Communities -->
```{r rename-commvars, include=FALSE}
## Change names to have search dimension first and commname second
## Help on regex part: https://stackoverflow.com/questions/952275/regex-group-capture-in-r-with-multiple-capture-groups
# search.vars <- grep('nhd\\.srch.+\\.', names(dcas), value=TRUE)
# new_search_matches <- regmatches(
#     search.vars, regexec('nhd\\.srch\\.(.+)\\.(.+)$', search.vars))
# new_search_names <- sapply(new_search_matches, function(x){
#     paste(rev(x[2:3]), collapse='_')})
# names(dcas)[names(dcas)%in%search.vars] <- new_search_names
# 
# dcas$consider_num <- rowSums(dcas[grep('^cons_', names(dcas))])
# dcas$consider_any <- dcas$consider_num > 0
# dcas$notconsider_num <- rowSums(dcas[grep('^nc_', names(dcas))])
# dcas$notconsider_any <- dcas$notconsider_num >0
```


### Independent Variable

**Race.** Set the reference level of the race variable (`dem.race`) to be whites.
```{r independent-variables}
dcas$dem.race <- relevel(dcas$dem.race, ref='white')
table(dcas$dem.race, useNA='always')

```


### Control Variables

#### Demographic variables

Create variables for demographic controls. 

**Age.** The age variable (`age`) was calculated by subtracting birth year from 2016. Represents age on December 31, 2016. Center age at 50. 

```{r demographic-variables-age, out.width='45%'}
dcas$age <- dcas$dem.age - 50 ## Center at age 50
qplot(dcas$age)
```

**Foreign born.** Variable (`forborn`) measuring whether respondent reported being born outside of the United States (reference=no).

```{r demographic-variables-forborn}
dcas$forborn <- dcas$dem.forborn
table(dcas$forborn, useNA='always')
```

**Male.** Variable measures whether the respondent reported being male. The option "other" was offered to respondents. Two respondents reported other and were counted as missing on this variable.

```{r demographic-variables-male}
dcas$man <- dcas$dem.gender.mf=='Male'
table(dcas[, c('dem.gender', 'man')], useNA='always')
```

**Kids.** Variable (`kids`) measures whether the respondent has any children under the age of 18 living at home. Recode unreasonable values to be missing. 
```{r demographic-variables-kids}
dcas$kids <- as.numeric(as.character(dcas$q2)) > 0
dcas$kids[as.numeric(as.character(dcas$q2)) > 90] <- NA
table(dcas[, c('q2', 'kids')], useNA='always')
```

**Married.** Variable (`married`) measures whether respondent is married or in a married-like relationship. 
```{r demographic-variables-married}
dcas$married <- grepl("Now married", dcas$dem.marital.stat)
table(dcas[,c('dem.marital.stat','married')], useNA='always') ##Check recoding
```

#### Socioeconomic Variables

**Educational attainment.** Create variable (`educ`) measuring educational attainment. Check variable was created correctly. 

```{r economic-variables-educ}
dcas$educ <- factor(dcas$dem.educ.attain, order=FALSE) %>% 
                relevel(ref='H.S.')
table(dcas[, c('dem.educ.attain', 'educ')], useNA='always')
# educ_dummies <- paste0('educ',1:5)
# dcas[,educ_dummies] <- lapply(1:5,
#         function(i) {unclass(dcas$dem.educ.attain)==i})
# for(i in 1:5) { ##Check recoding
#     print(table(dcas[,c('dem.educ.attain',paste0('educ',i))]))
# }
# educ_names <- levels(dcas$dem.educ.attain)
# educ_names[1] <- paste0("\\emph{Educational Attainment}&&\\\\", educ_names[1])
```

**Income.** Create variable (`inc`) measuring income using four levels. 
```{r economic-variables-inc}
dcas$inc <- dcas$dem.income.cat4
table(dcas$inc, useNA='always')
# inc_dummies <- paste0('inc',1:4)
# dcas[,inc_dummies] <- lapply(1:4,
#         function(i) {unclass(dcas$dem.income.cat4)==i})
# for(i in 1:4) { ## Check recoding
#     print(table(dcas[,c('dem.income.cat4',paste0('inc',i))]))
# }
# inc_names <- sanitize(levels(dcas$dem.income.cat4))
# inc_names[1] <- paste0("\\emph{Income}&&\\\\", inc_names[1])
```

*Missingness on Socioeconomic Variables.* Record how many respondents were missing educational attaiment and income data. Reported on page 12 of the manuscript.

```{r economic-variables-missing}
texcmds[['miinc']] <- sum(is.na(dcas$dem.income.cat4))
texcmds[['miedu']] <- sum(is.na(dcas$dem.educ.attain))
```

Variable   Missing
---------- -----------------------
Education  `r texcmds[['miedu']]`
Income     `r texcmds[['miinc']]`
---------- -----------------------

#### Neighborhood Perception Variables

**Years in the neighborhood.** Variable (`nhdyrs`) measures how long the respondent reported living in neighborhood. Center at 10 years and show histogram of values. 

```{r nhood-variables-years, out.width='45%'}
dcas$nhdyrs <- as.numeric(as.character(dcas$q4)) - 10 ## Center at 10 years
dcas$nhdyrsc <- scale(dcas$nhdyrs, scale=FALSE)
qplot(dcas$nhdyrsc)
```

**Perceived size of neighborhood.** Create three-category variable that measures perceived neighborhood size. Check that variable was created correctly. 
```{r nhood-variables-nhdsize}
dcas$nhdsize[unclass(dcas$nhd.size)%in%c(1,2)] <- '1-9 blocks'
dcas$nhdsize[unclass(dcas$nhd.size)%in%c(3,4)] <- '10-50 blocks'
dcas$nhdsize[unclass(dcas$nhd.size)==5] <- '>50 blocks'
dcas$nhdsize <- factor(dcas$nhdsize, 
                        levels=c('1-9 blocks', '10-50 blocks', '>50 blocks'))
dcas$nhdsize <- relevel(dcas$nhdsize, ref='1-9 blocks')
table(dcas[,c('nhd.size', 'nhdsize')], useNA='always') ## Check recoding
```

## Data Imputation and Weighting

Select variables to keep that will be used in analysis. Define vectors of identification and numeric ("nominal") variables that will be used for imputation. 
```{r weights-variables}
vars <- c(
          'satisfied', 'better'
          , 'extremely_satisfied', 'much_better'
          , 'dem.race'
          , 'age'
          , 'forborn'
          , 'man'
          , 'kids'
          , 'married'
          , 'educ'
          , 'nhdyrs'
          , 'nhdsize'
          , 'inc'
)
dcas$studycase <- as.character(dcas$studycase)
idvars <- c('studycase','weight', 'sample_strata', 'sample_tract')
nominals <- vars[!(vars %in% c('age', 'nhdyrs',
                               'consider_num', 'notconsider_num'))]

```

Create five imputation datasets of survey-weighted data and assign to object `dcasssvy`. 
```{r weights-assign}
# impute_weights <- function(dta){
#     set.seed(214518)
#     assign('dcasmi', amelia(dta, m=5, noms=nominals, emburn=c(500 , 500),
#                             p2s = F, idvars=idvars), envir=.GlobalEnv)
#     assign('dcassvy',
#            svydesign(id=~studycase,strata=~sample_strata, weights=~weight,
#                      data=imputationList(dcasmi$imputations)),
#            envir=.GlobalEnv)
# }
# impute_weights(dcas[,c(vars, idvars, commvars)])

```

Re-level the tract identification number used for fixed effects to the reference tract is that which has the median level of satisfaction. Re-impute the data.[^reimpute]

[^reimpute]: I'm not sure that the re-imputation is necessary since I could relevel the factor inside the variables of each design object.
```{r weignts-median-tract}
## Find tract with approximately median value of tract-level satisfaction
# tract_means <- MIcombine(
#     with(dcassvy, svyby(~satisfied, ~sample_tract, svymean)))$coefficients
# tract_means <- sort(tract_means)
# median_tract_id <- names(tract_means)[round(length(tract_means)/2)]
# dcas$sample_tract <- relevel(dcas$sample_tract, ref=median_tract_id)
# impute_weights(dcas[, c(idvars, vars, commvars)])

```

Save R object containing the multiply-imputed survey-weighted data (`dcassvy`), variable names (`vars`), imputation list upon which survey data were created (`dcasmi`), a string representing the diretory containing data (`dataDIR`), and the list of values to export to LaTeX (`texcmds`). 
```{r save-data}
# save(dcassvy, vars, dcas, dcasmi, dataDIR, texcmds,
#      file = '../data/dcassvy.Rdata')

```

