# Data Construction

Data for this manuscript come from the 2016 and 2018 DC Area Surveys. More information about the 2016 DC Area Survey can be found [here](http://bit.ly/dcas2016) and the 2018 DC Area Survey can be found [here](https://papers.ssrn.com/sol3/papers.cfm?abstract_id=3567219).

```{r load-data}
dataDIR <- '~/work/data/dcas/'
load(paste0(dataDIR,'dcas2016/Dataset/R/DCAS_2016_weighted.Rdata'))
dcas16 <- dcas

load(paste0(dataDIR,'dcas2018/dataset/DCAreaSurvey2018.Rdata'))
dcas18 <- dcas
rm(dcas)

```

## Respondent Selection

**Respondents Living in Multiracial Neighborhoods (DCAS 2016).** The DCAS 2016 data represent two populations: those living in multiracial neighborhoods and those living in disproportionately Latino neighborhoods. This manuscript only used data from the multiracial neighborhoods. I create a variable `quad` to represent these variables ('quad' comes from my [previous description](http://bit.ly/nhoodTrajPaper) of stable multiracial neighborhoods as 'quadrivial neighborhoods'). 

```{r subset-data}
dcas16$quad <- dcas16$neighborhood=='Global Neighborhood'
table(dcas16[,c('neighborhood','quad')]) ##Check variable
dcas16$sample_tract <- droplevels(dcas16$sample_tract)

```

```{r subset-data-bak}
# dcas16$quad <- dcas16$neighborhood=='Global Neighborhood'
# table(dcas16[,c('neighborhood','quad')])
# N_norace <- sum(is.na(dcas$dem.race) & dcas$quad==TRUE)
# dcas <- dcas[!is.na(dcas$dem.race) & dcas$quad==TRUE,]
# dcas$sample_tract <- droplevels(dcas$sample_tract)
# N_quad <- length(dcas$studycase)
# N <- sum(!is.na(dcas$dem.race))
# texcmds[['N']] <- N
```


## Variable Construction



### Dependent Variables

**Neighborhood Satisfaction.** Create neighborhood satisfaction variable (`satisfied`) to represent responses of "Extremely Satisfied" or "Very Satisfied". Check that the variable was created correctly.
```{r variables-satisfied}
dcas16$satisfied <- dcas16$nhd.satisfaction %in% c(
                       'Extremely satisfied','Very satisfied')*1
dcas16$nhdsat <- dcas16$nhd.satisfaction
table(dcas16[, c('nhd.satisfaction','satisfied')]) ##Check variable
table(dcas16[, c('nhd.satisfaction','nhdsat')]) ##Check variable

dcas18$satisfied <- dcas18$nhdsat %in% c('Extremely', 'Very')*1
table(dcas18[, c('nhdsat', 'satisfied')]) ##Checkvariable
```


**Neighborhood improvement.** Create variable (`better`) measuring whether respondent perceives that the neighborhood has improved. Include responses "Much better" and "Somewhat better". Check that variable was created correctly.
```{r variables-better}
betterlabs <- c("Much better", "Somewhat better")
changelabs <- c(
    "Much worse" = "Worse",
    "Somewhat worse" = "Worse",
    "About the same" = "Same",
    "Somewhat better" = "Better",
    "Much better" = "Better"
)
dcas16 <- dcas16 %>%
    mutate(
        better = ifelse(
            is.na(nhd.change), NA, 
            dcas16$nhd.change %in% betterlabs),
        nhdchg = recode_factor(nhd.change, !!!changelabs)
    )
table(dcas16[, c("nhd.change", "better")], useNA="always") ##Check variable
table(dcas16[, c("nhd.change", "nhdchg")], useNA="always") ##Check variable


dcas18 <- dcas18 %>%
    mutate(
        nhdchgbak = nhdchg,
        better = ifelse(
            is.na(nhdchgbak), NA, 
            nhdchgbak %in% betterlabs),
        nhdchg = recode_factor(nhdchgbak, !!!changelabs)
    )
table(dcas18[, c("nhdchgbak", "better")], useNA="always") ##Check variable
table(dcas18[, c("nhdchgbak", "nhdchg")], useNA="always") ##Check variable

```

### Independent Variable

**Race.** Set the reference level of the race variable to be whites.

```{r independent-variables}
dcas16 <- dcas16 %>%
    mutate(
        raceeth = recode_factor(dem.race, api = "asian"),
        raceeth = relevel(raceeth, ref="white")
    )
table(dcas16[, c('dem.race', 'raceeth')], useNA='always') ##Check variable

racelabs <- c(
    "White" = "white",
    "Asian/Pac. Islander" = "asian",
    "Black" = "black",
    "Latinx" = "latino",
    "Native American" = "other",
    "Other" = "other"
)
dcas18 <- dcas18 %>%
    mutate(
        raceethbak = raceeth,
        raceeth = recode_factor(raceeth, !!!racelabs),
        raceeth = relevel(raceeth, ref="white")
    )
table(dcas18[, c('raceethbak', 'raceeth')], useNA="always") ##Check variable

```


### Control Variables

#### Demographic variables

Create variables for demographic controls. 

**Age.** The age variable (`age`) was calculated by subtracting birth year from 2016. Represents age on December 31, 2016. Center age at 50. 

```{r demographic-variables-age, out.width='45%'}
dcas16$age <- dcas16$dem.age - 50 ## Center at age 50
qplot(dcas16$age, labs=c(title="2016"))

dcas18$age <- dcas18$age - 50
qplot(dcas18$age, labs=c(title="2018"))
```

**Foreign born.** Variable (`forborn`) measuring whether respondent reported being born outside of the United States (reference=no).

```{r demographic-variables-forborn}
dcas16$forborn <- dcas16$dem.forborn
table(dcas16[, c("dem.forborn", "forborn")], useNA='always') ##Check variable

dcas18 <- dcas18 %>%
    mutate(
        forborn = ifelse(is.na(usborn), NA,
                         usborn %in% c("United States", "Puerto Rico"))
    )
table(dcas18[, c("usborn", "forborn")], useNA="always") ##Check variable

```

**Male.** Variable measures whether the respondent reported being male. The option "other" was offered to respondents. Two respondents in 2016 and five respondents in 2018 reported other and were counted as missing on this variable.

```{r demographic-variables-male}
dcas16$man <- dcas16$dem.gender.mf=='Male'
table(dcas16[, c('dem.gender', 'man')], useNA='always')

dcas18 <- dcas18 %>%
    mutate(man = recode_factor(
        gender, Male=TRUE, Female=FALSE, `In another way`=NA
    ))
table(dcas18[, c("gender","man")], useNA="always") 

```

**Kids.** Variable (`kids`) measures whether the respondent has any children under the age of 18 living at home. Recode unreasonable values to be missing. 
```{r demographic-variables-kids}
dcas16$kids <- as.numeric(as.character(dcas16$q2)) > 0
dcas16$kids[as.numeric(as.character(dcas16$q2)) > 90] <- NA
table(dcas16[, c('q2', 'kids')], useNA='always')

dcas18$kidsbak <- dcas18$kids
dcas18$kids <- ifelse(!is.na(dcas18$kidsbak), dcas18$kidsbak>0, NA)
table(dcas18[, c('kidsbak', 'kids')], useNA="always")

```

**Married.** Variable (`married`) measures whether respondent is married or in a married-like relationship. 
```{r demographic-variables-married}
dcas16$married <- grepl("Now married", dcas16$dem.marital.stat)
table(dcas16[,c('dem.marital.stat','married')], useNA='always') ##Check recoding

dcas18$marriedbak <- dcas18$married
dcas18$married <- dcas18$marriedbak == "Married"
table(dcas18[, c("marriedbak", "married")], useNA="always") ##Check variable

```

#### Socioeconomic Variables

**Educational attainment.** Create variable (`educ`) measuring educational attainment. Check variable was created correctly. 

```{r economic-variables-educ}
dcas16$educ <- factor(dcas16$dem.educ.attain, order=FALSE) %>% 
                relevel(ref='H.S.')
table(dcas16[, c('dem.educ.attain', 'educ')], useNA='always')

educlabs <- c(
    "Less than HS" = "<H.S.",
    "Did not finish HS" = "<H.S.",
    "HS diploma or GED" = "H.S.",
    "Some college, no degree" = "Some college, no B.A.",
    "Associate\'s degree" = "Some college, no B.A.",
    "Bachelor\'s degree" = "B.A.",
    "Advanced degree" = "M.A.+"
)

dcas18 <- dcas18 %>%
    mutate(
        educbak = educ,
        educ = recode_factor(educbak, !!!educlabs),
        educ = relevel(educ, ref="H.S.")
    )
table(dcas18[, c("educbak", "educ")], useNA="always")

```

**Income.** Create variable (`inc`) measuring income using four levels. 
```{r economic-variables-inc}
# dcas16$inc <- dcas16$dem.income.cat4
# table(dcas16$inc, useNA='always')
# inc_dummies <- paste0('inc',1:4)
# dcas[,inc_dummies] <- lapply(1:4,
#         function(i) {unclass(dcas$dem.income.cat4)==i})
# for(i in 1:4) { ## Check recoding
#     print(table(dcas[,c('dem.income.cat4',paste0('inc',i))]))
# }
# inc_names <- sanitize(levels(dcas$dem.income.cat4))
# inc_names[1] <- paste0("\\emph{Income}&&\\\\", inc_names[1])

# table(dcas18$income, useNA="always")

```

*Missingness on Socioeconomic Variables.* Record how many respondents were missing educational attaiment and income data. 

```{r economic-variables-missing}
texcmds[['miinc16']] <- sum(is.na(dcas16$dem.income.cat4))
texcmds[['miedu16']] <- sum(is.na(dcas16$dem.educ.attain))

texcmds[['miinc18']] <- sum(is.na(dcas18$income))
texcmds[['miedu18']] <- sum(is.na(dcas18$educ))

```

Variable   Missing 2016              Missing 2018
---------- ------------------------- -------------------------
Education  `r texcmds[['miedu16']]`  `r texcmds[['miedu18']]`
Income     `r texcmds[['miinc16']]`  `r texcmds[['miinc18']]`
---------- ------------------------- -------------------------

#### Neighborhood Experience Variables

**Years in the neighborhood.** Variable (`nhdyrs`) measures how long the respondent reported living in neighborhood.  

```{r nhood-variables-years, out.width='45%'}
dcas16$nhdyrs <- as.numeric(as.character(dcas16$q4)) 
qplot(dcas16$nhdyrs, binwidth=5)

dcas18$nhdyrs <- dcas18$yrsnhd
qplot(dcas18$nhdyrs) #uh-oh

```

**Perceived size of neighborhood.** Create three-category variable that measures perceived neighborhood size. Check that variable was created correctly. 
```{r nhood-variables-nhdsize}
sizelabs <- c(
    `1 to 4 blocks` = "1-9 blocks",
    `5 to 9 blocks` = "1-9 blocks",
    `10 to 25 blocks` = "10-50 blocks",
    `25 to 50 blocks` = "10-50 blocks",
    `More than 50 blocks` = ">50 blocks"
)
dcas16 = mutate(dcas16, nhdsize = recode_factor(nhd.size, !!!sizelabs))
table(dcas16[, c('nhd.size', 'nhdsize')], useNA="always") ## Check variable

names(sizelabs) <- gsub(" to ", "-", names(sizelabs))
dcas18 <- dcas18 %>%
    mutate(
        nhdsizebak = nhdsize, 
        nhdsize = recode_factor(nhdsize, !!!sizelabs)
    )
table(dcas18[, c('nhdsizebak','nhdsize')], useNA="always") #Check variable

```

## Data Imputation and Weighting

Select variables to keep that will be used in analysis. Define vectors of identification and numeric variables that will be used for imputation. 
```{r weights-variables}
vars <- c(
          # 'satisfied', 'better',
          'nhdsat', 'nhdchg'
          , 'raceeth'
          , 'age'
          , 'forborn'
          , 'man'
          , 'kids'
          , 'married'
          , 'educ'
          , 'nhdyrs'
          , 'nhdsize'
          # , 'inc'
)
dcas16 <- dcas16 %>%
    mutate(
        rid = as.character(studycase),
        strata = sample_strata
    )
dcas16$rid <- as.character(dcas16$studycase)
idvars16 <- c('rid','weight', 'strata', 'sample_tract')
nominals <- vars[!(vars %in% c('age', 'nhdyrs'))]

dcas18$rid <- as.character(dcas18$rid)
idvars18 <- c("rid", "weight", "strata")
```

Re-level the tract identification number used for fixed effects to the reference tract is that which has the median level of satisfaction. 

```{r weights-median-tract}
satmu <- dcas16 %>%
    select(sample_tract, satisfied) %>%
    group_by(sample_tract) %>%
    summarize(meansat = mean(satisfied, na.rm=TRUE)) %>%
    arrange(meansat) 
medsatid <- satmu$sample_tract[round(nrow(satmu)/2)] %>% as.character()
dcas16$sample_tract <- relevel(dcas16$sample_tract, ref=medsatid)
# levels(dcas16$sample_tract) ## Not run: Check referencing

```

Create five imputation datasets of survey-weighted data and assign to object `dcasYRsvy`. 
```{r weights-assign}
set.seed(214518)
dcas16mi <- amelia(dcas16[, c(vars, idvars16, 'satisfied', 'better')], 
                   m=5, noms=nominals, emburn=c(500, 500),
                   p2s=FALSE, idvars=c(idvars16, 'satisfied', 'better'))
dcas16svy <- svydesign(id=~rid, strata=~strata, weights=~weight,
                       data=imputationList(dcas16mi$imputations))

dcas18mi <- amelia(dcas18[, c(vars, idvars18, 'satisfied', 'better')], 
                   m=5, noms=nominals, emburn=c(500,500),
                   p2s=FALSE, idvars=c(idvars18, 'satisfied', 'better'))
dcas18svy <- svydesign(id=~rid, strata=~strata, weights=~weight,
                       data=imputationList(dcas18mi$imputations))


```


Save R object containing the multiply-imputed survey-weighted data (`dcassvy`), variable names (`vars`), imputation list upon which survey data were created (`dcasmi`), a string representing the diretory containing data (`dataDIR`), and the list of values to export to LaTeX (`texcmds`). 
```{r save-data}
save(vars, dataDIR, texcmds,
     dcas16svy, dcas16, dcas16mi, 
     dcas18svy, dcas18, dcas18mi,
     file = '../data/dcassvy.Rdata')

```

